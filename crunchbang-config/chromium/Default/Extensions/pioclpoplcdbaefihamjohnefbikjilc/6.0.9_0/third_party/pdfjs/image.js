var PDFImage=function(){function p(g,b,c,a,f){if(a instanceof JpegStream&&a.isNativelyDecodable(b,c)){var e=a.dict.get("ColorSpace","CS"),e=ColorSpace.parse(e,b,c);b=e.numComps;g.send("JpegDecode",[a.getIR(),b],function(b){b=b.data;b=new Stream(b,0,b.length,a.dict);f.resolve(b)})}else f.resolve(a)}function l(g,b,c,a,f,e){this.image=c;c.getParams&&TODO("get params from actual stream");a=c.dict;this.width=a.get("Width","W");this.height=a.get("Height","H");(1>this.width||1>this.height)&&error("Invalid image width: "+
this.width+" or height: "+this.height);this.interpolate=a.get("Interpolate","I")||!1;this.imageMask=a.get("ImageMask","IM")||!1;c=c.bitsPerComponent;c||(c=a.get("BitsPerComponent","BPC"))||(this.imageMask?c=1:error("Bits per component missing in image: "+this.imageMask));this.bpc=c;if(!this.imageMask){var d=a.get("ColorSpace","CS");d||(TODO('JPX images (which don"t require color spaces'),d=new Name("DeviceRGB"));this.colorSpace=ColorSpace.parse(d,g,b);this.numComps=this.colorSpace.numComps}this.decode=
a.get("Decode","D");this.needsDecode=!1;if(this.decode&&this.colorSpace&&!this.colorSpace.isDefaultDecode(this.decode))for(this.needsDecode=!0,a=(1<<c)-1,this.decodeCoefficients=[],this.decodeAddends=[],d=c=0;c<this.decode.length;c+=2,++d){var h=this.decode[c];this.decodeCoefficients[d]=this.decode[c+1]-h;this.decodeAddends[d]=a*h}f?this.smask=new l(g,b,f,!1):e&&(isStream(e)?this.mask=new l(g,b,e,!1):this.mask=e)}l.buildImage=function(g,b,c,a,f,e){var d=new Promise,h=new Promise,k=new Promise;Promise.all([d,
h,k]).then(function(b){b=new l(c,a,b[0],e,b[1],b[2]);g(b)});p(b,c,a,f,d);d=f.dict.get("SMask");f=f.dict.get("Mask");d?(p(b,c,a,d,h),k.resolve(null)):(h.resolve(null),f?isStream(f)?p(b,c,a,f,k):isArray(f)?k.resolve(f):(warn("Unsupported mask format."),k.resolve(null)):k.resolve(null))};l.resize=function(g,b,c,a,f,e,d){var h=e*d*c;b=8>=b?new Uint8Array(h):16>=b?new Uint16Array(h):new Uint32Array(h);h=a/e;f/=d;for(var k,t,m,l=0;l<d;l++)for(var n=0;n<e;n++)k=Math.floor(n*h),t=Math.floor(l*f),m=l*e+n,
k=t*a+k,1===c?b[m]=g[k]:3===c&&(m*=3,k*=3,b[m]=g[k],b[m+1]=g[k+1],b[m+2]=g[k+2]);return b};l.prototype={get drawWidth(){return this.smask?Math.max(this.width,this.smask.width):this.width},get drawHeight(){return this.smask?Math.max(this.height,this.smask.height):this.height},getComponents:function(g){var b=this.bpc,c=this.needsDecode,a=this.decode;if(8==b&&!c)return g;var f=this.width,e=this.numComps,d=f*this.height*e,h=0,k=8>=b?new Uint8Array(d):16>=b?new Uint16Array(d):new Uint32Array(d),f=f*e,
l,m;c&&(l=this.decodeAddends,m=this.decodeCoefficients);var p=(1<<b)-1;if(8==b)for(a=0;a<d;++a){var n=a%e,q=g[a],h=q,h=l[n]+h*m[n],q=0>h?0:h>p?p:h;k[a]=q}else if(1==b){e=0;l=1;a&&(e=a[0]?1:0,l=a[1]?1:0);for(var r=m=0,a=0;a<d;++a)0==a%f?r=m=0:m>>=1,0>=m&&(r=g[h++],m=128),k[a]=r&m?l:e}else for(a=r=n=0;a<d;++a){0==a%f&&(n=r=0);for(;n<b;)r=r<<8|g[h++],n+=8;var s=n-b,q=r>>s;c&&(n=a%e,q=l[n]+q*m[n],q=0>q?0:q>p?p:q);k[a]=q;r&=(1<<s)-1;n=s}return k},getOpacity:function(g,b,c){var a=this.smask,f=this.mask,
e;if(a){c=a.width;var d=a.height;e=new Uint8Array(c*d);a.fillGrayBuffer(e);if(c!=g||d!=b)e=l.resize(e,a.bpc,1,c,d,g,b)}else if(f)if(f instanceof l){c=f.width;d=f.height;e=new Uint8Array(c*d);f.numComps=1;f.fillGrayBuffer(e);for(var a=0,h=c*d;a<h;++a)e[a]=255-e[a];if(c!=g||d!=b)e=l.resize(e,f.bpc,1,c,d,g,b)}else if(isArray(f))for(e=new Uint8Array(g*b),d=this.numComps,a=0,h=g*b;a<h;++a){g=0;b=a*d;for(var k=0;k<d;++k){var p=c[b+k],m=2*k;if(p<f[m]||p>f[m+1]){g=255;break}}e[a]=g}else error("Unknown mask format.");
else for(e=new Uint8Array(g*b),a=0,h=g*b;a<h;++a)e[a]=255;return e},applyStencilMask:function(g,b){var c=this.width,a=this.height,f=this.getImageBytes((c+7>>3)*a),e=0,d,h,k,l,m=3;for(d=0;d<a;d++)for(h=k=0;h<c;h++)k||(l=f[e++],k=128),!(l&k)==b&&(g[m]=0),m+=4,k>>=1},fillRgbaBuffer:function(g,b,c){var a=this.width,f=this.height,e=this.bpc,d=a*this.numComps*e+7>>3,h=this.getImageBytes(f*d),d=0|h.length/d*c/f,e=this.colorSpace.createRgbBuffer(this.getComponents(h),0,a*f,e);if(a!=b||f!=c)e=l.resize(e,this.bpc,
3,a,f,b,c);a=0;c=this.getOpacity(b,c,h);h=0;b=4*b*d;for(d=0;d<b;d+=4)g[d]=e[a++],g[d+1]=e[a++],g[d+2]=e[a++],g[d+3]=c[h++]},fillGrayBuffer:function(g){var b=this.numComps;1!=b&&error("Reading gray scale from a color image: "+b);for(var c=this.width,a=this.height,f=this.bpc,b=this.getImageBytes(a*(c*b*f+7>>3)),b=this.getComponents(b),c=c*a,f=255/((1<<f)-1),a=0;a<c;++a)g[a]=f*b[a]|0},getImageData:function(){var g=this.drawWidth,b=this.drawHeight,c={width:g,height:b,data:new Uint8Array(4*g*b)};this.fillRgbaBuffer(c.data,
g,b);return c},getImageBytes:function(g){this.image.reset();return this.image.getBytes(g)}};return l}();function loadJpegStream(p,l,g){var b=new Image;b.onload=function(){g.resolve(p,b)};b.src="data:image/jpeg;base64,"+window.btoa(l)};
