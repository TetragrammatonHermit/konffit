var NAME=SIM_SEARCH_NAME,baseUrl,locale,userId,shardId,client,userType,analyticsRecorded=!1,notesClicked={},totalNumNotes=0,numBizNotes=0;
window.addEventListener("DOMContentLoaded",function(){GlobalUtils.localize(document.body);document.querySelector("#closeButton").addEventListener("click",toggleCloseOptions);document.querySelector("#dismiss").addEventListener("click",dismiss);document.querySelector("#dismissForever").addEventListener("click",dismissForever);var b=decodeURI(document.location.href),a=/locale=(.+)&baseUrl=([^&]+)/.exec(b);locale=a[1];baseUrl=a[2];if(a=/userId=(.+)&shardId=(.+)&client=(.+)&userType=(.+)/.exec(b))userId=
a[1],shardId=a[2],client=a[3],userType=a[4];/china/i.test(locale)&&(document.querySelector(".branding span").className="china");startSecretGeneration()});window.addEventListener("unload",recordAnalytics);window.addEventListener("beforeunload",recordAnalytics);
function msgHandlerReceiveRelatedNotes(b,a,c){document.querySelector(".branding").href=baseUrl+"/SetAuthToken.action?auth="+encodeURIComponent(b.tokens.pers)+"&targetUrl="+encodeURIComponent("/Home.action");if(b.relatedNotes){a=b.relatedNotes;var d;"account"===b.type?(d=document.querySelector("#account .noteSectionNotes"),c=b.isBizUser?"searchHelperTopMatchesBiz":"searchHelperTopMatchesPers",1==a.length&&(c+="One"),c=Browser.i18n.getMessage(c,[a.length]),document.querySelector("#account .noteSectionTitle").innerText=
c):"library"===b.type?(d=document.querySelector("#library .noteSectionNotes"),1==a.length?document.querySelector("#library .noteSectionTitle").innerText=Browser.i18n.getMessage("searchHelperTopBizLibraryMatchesOne"):document.querySelector("#library .noteSectionTitle").innerText=Browser.i18n.getMessage("searchHelperTopBizLibraryMatches",[a.length])):"all"===b.type&&(d=document.querySelector("#all .noteSectionNotes"),1==a.length?document.querySelector("#all .noteSectionTitle").innerText=Browser.i18n.getMessage("searchHelperTopMatchesPersOne"):
document.querySelector("#all .noteSectionTitle").innerText=Browser.i18n.getMessage("searchHelperTopMatchesPers",[a.length]));d.parentNode.style.display=0<a.length?"block":"none";b=new NoteSnippets(d,baseUrl,userId,shardId,client,b.tokens,null,!0,function(a,b){notesClicked[a]=b?2:1});b.renderBlocks(a);totalNumNotes+=a.length;for(c=0;c<a.length;c++)a[c].inBusinessNotebook&&numBizNotes++;var f=document.createElement("div");f.className="noteSectionShadow";d.parentNode.insertBefore(f,d);d.addEventListener("overflowchanged",
function(a){f.style.display=a.horizontalOverflow?"block":"none"});"block"==document.querySelector("#noNotes").style.display&&(document.querySelector("#noNotes").style.display="none",Browser.sendToExtension({name:"setPersistentValue",key:userId+"_noSimsearchResultsShown",value:!1}));port.postMessage({name:"simSearch_sendHeight",height:getWindowHeight(b.hasAtLeastOneNotebookName())})}else document.querySelector("#"+b.type+" .noteSectionNotes").parentNode.style.display="none",document.querySelector("#"+
b.type+" .noteSectionNotes").innerHTML="",0<getWindowHeight()||(b.noSimsearchResultsShown&&!1!=b.noSimsearchResultsShown?port.postMessage({name:"simSearch_sendHeight",height:0}):(document.querySelector("#noNotes").style.display="block",port.postMessage({name:"simSearch_sendHeight",height:getWindowHeight()}),Browser.sendToExtension({name:"setPersistentValue",key:userId+"_noSimsearchResultsShown",value:!0})))}
function getWindowHeight(b){var a=document.querySelector("#account .noteSectionNotes"),c=document.querySelector("#library .noteSectionNotes"),d=document.querySelector("#all .noteSectionNotes"),f=document.querySelector("#noNotes"),e=0;""!=a.innerHTML&&(e=263);if(""!=c.innerHTML||""!=d.innerHTML)e=b?282:263;""!=a.innerHTML&&""!=c.innerHTML&&(e=500);"block"==f.style.display&&(e=85);return e}
function toggleCloseOptions(){"block"==document.querySelector("#closeOptions").style.display?document.querySelector("#closeOptions").style.display="none":document.querySelector("#closeOptions").style.display="block"}function dismiss(){port.postMessage({name:"simSearch_sendHeight",height:0});port.postMessage({name:"temporarilyDisableSimSearch"})}function dismissForever(){dismiss();Browser.sendToExtension({name:"main_setOption",options:{useSearchHelper:!1}})}
function tellUserToLogin(){document.querySelector("#simSearchNotes").innerHTML=Browser.i18n.getMessage("searchHelperLoginMessage",[baseUrl+"/Login.action"]);port.postMessage({name:"simSearch_sendHeight",height:85})}
function recordAnalytics(){if(!analyticsRecorded&&totalNumNotes&&(analyticsRecorded=!0,Browser.sendToExtension({name:"trackEvent",userId:userId,category:"Simsearch",action:"general clickthru",label:userType,value:100*Object.keys(notesClicked).length/totalNumNotes}),"business"==userType&&0<numBizNotes)){var b=0,a;for(a in notesClicked)2==notesClicked[a]&&b++;Browser.sendToExtension({name:"trackEvent",userId:userId,category:"Simsearch",action:"business clickthru",label:userType,value:100*b/Object.keys(notesClicked).length})}}
function portReady(){userId?(Browser.addMessageHandlers({simsearch_receiveRelatedNotes:msgHandlerReceiveRelatedNotes,tellUserToLogin:tellUserToLogin}),Browser.sendToExtension({name:"simSearch_getNotesRelatedToSearchQuery"})):tellUserToLogin()};
