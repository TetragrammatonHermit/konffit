var JpegImage=function(){function R(){}function U(e,k){for(var r=0,p=[],b,s,t=16;0<t&&!e[t-1];)t--;p.push({children:[],index:0});var f=p[0],l;for(b=0;b<t;b++){for(s=0;s<e[b];s++){f=p.pop();for(f.children[f.index]=k[r];0<f.index;)f=p.pop();f.index++;for(p.push(f);p.length<=b;)p.push(l={children:[],index:0}),f.children[f.index]=l.children,f=l;r++}b+1<t&&(p.push(l={children:[],index:0}),f.children[f.index]=l.children,f=l)}return p[0].children}function V(e,k,r,p,b,s,t,f,l){function c(){if(0<u)return u--,
m>>u&1;m=e[k++];if(255==m){var a=e[k++];if(a)throw"unexpected marker: "+(m<<8|a).toString(16);}u=7;return m>>>7}function y(a){for(var b;null!==(b=c());){a=a[b];if("number"===typeof a)return a;if("object"!==typeof a)throw"invalid huffman sequence";}return null}function C(a){for(var b=0;0<a;){var d=c();if(null===d)return;b=b<<1|d;a--}return b}function q(a){var c=C(a);return c>=1<<a-1?c:c+(-1<<a)+1}function a(a,c){var b=y(a.huffmanTableDC),b=0===b?0:q(b);c[0]=a.pred+=b;for(b=1;64>b;){var d=y(a.huffmanTableAC),
f=d&15,d=d>>4;if(0===f){if(15>d)break;b+=16}else b+=d,c[J[b]]=q(f),b++}}function d(a,c){var b=y(a.huffmanTableDC),b=0===b?0:q(b)<<l;c[0]=a.pred+=b}function w(a,b){b[0]|=c()<<l}function h(a,c){if(0<B)B--;else for(var b=s,d=t;b<=d;){var f=y(a.huffmanTableAC),e=f&15,f=f>>4;if(0===e){if(15>f){B=C(f)+(1<<f)-1;break}b+=16}else b+=f,c[J[b]]=q(e)*(1<<l),b++}}function n(a,b){for(var d=s,f=t,e=0;d<=f;){var m=J[d];switch(x){case 0:e=y(a.huffmanTableAC);m=e&15;e>>=4;if(0===m)15>e?(B=C(e)+(1<<e),x=4):(e=16,x=
1);else{if(1!==m)throw"invalid ACn encoding";g=q(m);x=e?2:3}continue;case 1:case 2:b[m]?b[m]+=c()<<l:(e--,0===e&&(x=2==x?3:0));break;case 3:b[m]?b[m]+=c()<<l:(b[m]=g<<l,x=0);break;case 4:b[m]&&(b[m]+=c()<<l)}d++}4===x&&(B--,0===B&&(x=0))}var v=r.mcusPerLine,z=k,m=0,u=0,B=0,x=0,g,A=p.length,D,G,E,F,I;f=r.progressive?0===s?0===f?d:w:0===f?h:n:a;var H=0;r=1==A?p[0].blocksPerLine*p[0].blocksPerColumn:v*r.mcusPerColumn;b||(b=r);for(var S,T;H<r;){for(G=0;G<A;G++)p[G].pred=0;B=0;if(1==A)for(D=p[0],I=0;I<
b;I++)f(D,D.blocks[H/D.blocksPerLine|0][H%D.blocksPerLine]),H++;else for(I=0;I<b;I++){for(G=0;G<A;G++)for(D=p[G],S=D.h,T=D.v,E=0;E<T;E++)for(F=0;F<S;F++)f(D,D.blocks[(H/v|0)*D.v+E][H%v*D.h+F]);H++}u=0;D=e[k]<<8|e[k+1];if(65280>=D)throw"marker was not found";if(65488<=D&&65495>=D)k+=2;else break}return k-z}function W(e,k){for(var r=[],p=k.blocksPerLine,b=k.blocksPerColumn,s=p<<3,t=new Int32Array(64),f=new Uint8Array(64),l,c,y=0;y<b;y++){var C=y<<3;for(l=0;8>l;l++)r.push(new Uint8Array(s));for(var q=
0;q<p;q++){var a=k.blocks[y][q];l=f;var d=t,w=k.quantizationTable,h=void 0,n=void 0,v=void 0,z=void 0,m=void 0,u=void 0,B=void 0,x=void 0,g=void 0;c=d;for(var A=void 0,A=0;64>A;A++)c[A]=a[A]*w[A];for(A=0;8>A;++A)a=8*A,0==c[1+a]&&0==c[2+a]&&0==c[3+a]&&0==c[4+a]&&0==c[5+a]&&0==c[6+a]&&0==c[7+a]?(g=F*c[0+a]+512>>10,c[0+a]=g,c[1+a]=g,c[2+a]=g,c[3+a]=g,c[4+a]=g,c[5+a]=g,c[6+a]=g,c[7+a]=g):(h=F*c[0+a]+128>>8,n=F*c[4+a]+128>>8,v=c[2+a],z=c[6+a],m=K*(c[1+a]-c[7+a])+128>>8,x=K*(c[1+a]+c[7+a])+128>>8,u=c[3+
a]<<4,B=c[5+a]<<4,g=h-n+1>>1,h=h+n+1>>1,n=g,g=v*L+z*M+128>>8,v=v*M-z*L+128>>8,z=g,g=m-B+1>>1,m=m+B+1>>1,B=g,g=x+u+1>>1,u=x-u+1>>1,x=g,g=h-z+1>>1,h=h+z+1>>1,z=g,g=n-v+1>>1,n=n+v+1>>1,v=g,g=m*N+x*O+2048>>12,m=m*O-x*N+2048>>12,x=g,g=u*P+B*Q+2048>>12,u=u*Q-B*P+2048>>12,B=g,c[0+a]=h+x,c[7+a]=h-x,c[1+a]=n+B,c[6+a]=n-B,c[2+a]=v+u,c[5+a]=v-u,c[3+a]=z+m,c[4+a]=z-m);for(A=0;8>A;++A)a=A,0==c[8+a]&&0==c[16+a]&&0==c[24+a]&&0==c[32+a]&&0==c[40+a]&&0==c[48+a]&&0==c[56+a]?(g=F*d[A+0]+8192>>14,c[0+a]=g,c[8+a]=g,c[16+
a]=g,c[24+a]=g,c[32+a]=g,c[40+a]=g,c[48+a]=g,c[56+a]=g):(h=F*c[0+a]+2048>>12,n=F*c[32+a]+2048>>12,v=c[16+a],z=c[48+a],m=K*(c[8+a]-c[56+a])+2048>>12,x=K*(c[8+a]+c[56+a])+2048>>12,u=c[24+a],B=c[40+a],g=h-n+1>>1,h=h+n+1>>1,n=g,g=v*L+z*M+2048>>12,v=v*M-z*L+2048>>12,z=g,g=m-B+1>>1,m=m+B+1>>1,B=g,g=x+u+1>>1,u=x-u+1>>1,x=g,g=h-z+1>>1,h=h+z+1>>1,z=g,g=n-v+1>>1,n=n+v+1>>1,v=g,g=m*N+x*O+2048>>12,m=m*O-x*N+2048>>12,x=g,g=u*P+B*Q+2048>>12,u=u*Q-B*P+2048>>12,B=g,c[0+a]=h+x,c[56+a]=h-x,c[8+a]=n+B,c[48+a]=n-B,c[16+
a]=v+u,c[40+a]=v-u,c[24+a]=z+m,c[32+a]=z-m);for(A=0;64>A;++A)d=128+(c[A]+8>>4),l[A]=0>d?0:255<d?255:d;A=0;d=q<<3;for(c=0;8>c;c++)for(h=r[C+c],l=0;8>l;l++)h[d+l]=f[A++]}}return r}function E(e){return 0>e?0:255<e?255:e}var J=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),Q=4017,P=799,O=3406,N=2276,M=1567,L=3784,F=5793,K=2896;R.prototype={load:function(e){var k=
new XMLHttpRequest;k.open("GET",e,!0);k.responseType="arraybuffer";k.onload=function(){var e=new Uint8Array(k.response||k.mozResponseArrayBuffer);this.parse(e);if(this.onload)this.onload()}.bind(this);k.send(null)},parse:function(e){function k(){var a=e[b]<<8|e[b+1];b+=2;return a}function r(){var a=k(),a=e.subarray(b,b+a-2);b+=a.length;return a}function p(a){var b=0,c=0,d,e;for(e in a.components)a.components.hasOwnProperty(e)&&(d=a.components[e],b<d.h&&(b=d.h),c<d.v&&(c=d.v));var f=Math.ceil(a.samplesPerLine/
8/b),h=Math.ceil(a.scanLines/8/c);for(e in a.components)if(a.components.hasOwnProperty(e)){d=a.components[e];for(var k=Math.ceil(Math.ceil(a.samplesPerLine/8)*d.h/b),l=Math.ceil(Math.ceil(a.scanLines/8)*d.v/c),n=f*d.h,p=h*d.v,q=[],r=0;r<p;r++){for(var s=[],t=0;t<n;t++)s.push(new Int32Array(64));q.push(s)}d.blocksPerLine=k;d.blocksPerColumn=l;d.blocks=q}a.maxH=b;a.maxV=c;a.mcusPerLine=f;a.mcusPerColumn=h}var b=0,s=null,t=null,f,l,c=[],y=[],C=[],q=[],a=k();if(65496!=a)throw"SOI not found";for(a=k();65497!=
a;){var d;switch(a){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:d=r();65504===a&&74===d[0]&&70===d[1]&&73===d[2]&&70===d[3]&&0===d[4]&&(s={version:{major:d[5],minor:d[6]},densityUnits:d[7],xDensity:d[8]<<8|d[9],yDensity:d[10]<<8|d[11],thumbWidth:d[12],thumbHeight:d[13],thumbData:d.subarray(14,14+3*d[12]*d[13])});65518===a&&65===d[0]&&100===d[1]&&111===d[2]&&
98===d[3]&&101===d[4]&&0===d[5]&&(t={version:d[6],flags0:d[7]<<8|d[8],flags1:d[9]<<8|d[10],transformCode:d[11]});break;case 65499:for(a=k()+b-2;b<a;){var w=e[b++],h=new Int32Array(64);if(0===w>>4)for(d=0;64>d;d++){var n=J[d];h[n]=e[b++]}else if(1===w>>4)for(d=0;64>d;d++)n=J[d],h[n]=k();else throw"DQT: invalid table spec";c[w&15]=h}break;case 65472:case 65474:k();f={};f.progressive=65474===a;f.precision=e[b++];f.scanLines=k();f.samplesPerLine=k();f.components={};f.componentsOrder=[];d=e[b++];for(a=
0;a<d;a++){var w=e[b],h=e[b+1]>>4,n=e[b+1]&15,v=e[b+2];f.componentsOrder.push(w);f.components[w]={h:h,v:n,quantizationTable:c[v]};b+=3}p(f);y.push(f);break;case 65476:w=k();for(a=2;a<w;){h=e[b++];n=new Uint8Array(16);for(d=v=0;16>d;d++,b++)v+=n[d]=e[b];var z=new Uint8Array(v);for(d=0;d<v;d++,b++)z[d]=e[b];a+=17+v;(0===h>>4?q:C)[h&15]=U(n,z)}break;case 65501:k();l=k();break;case 65498:k();w=e[b++];d=[];for(a=0;a<w;a++)h=f.components[e[b++]],n=e[b++],h.huffmanTableDC=q[n>>4],h.huffmanTableAC=C[n&15],
d.push(h);a=e[b++];w=e[b++];h=e[b++];a=V(e,b,f,d,l,a,w,h>>4,h&15);b+=a;break;default:if(255==e[b-3]&&192<=e[b-2]&&254>=e[b-2]){b-=3;break}throw"unknown JPEG marker "+a.toString(16);}a=k()}if(1!=y.length)throw"only single frame JPEGs supported";this.width=f.samplesPerLine;this.height=f.scanLines;this.jfif=s;this.adobe=t;this.components=[];for(a=0;a<f.componentsOrder.length;a++)h=f.components[f.componentsOrder[a]],this.components.push({lines:W(f,h),scaleX:h.h/f.maxH,scaleY:h.v/f.maxV})},getData:function(e,
k){var r=this.width/e,p=this.height/k,b,s,t,f,l,c,y,C,q,a,d=0,w,h,n,v,z,m,u=new Uint8Array(e*k*this.components.length);switch(this.components.length){case 1:b=this.components[0];for(a=0;a<k;a++)for(l=b.lines[0|a*b.scaleY*p],q=0;q<e;q++)w=l[0|q*b.scaleX*r],u[d++]=w;break;case 3:m=!0;this.adobe&&this.adobe.transformCode?m=!0:"undefined"!==typeof this.colorTransform&&(m=!!this.colorTransform);b=this.components[0];s=this.components[1];t=this.components[2];for(a=0;a<k;a++)for(l=b.lines[0|a*b.scaleY*p],
c=s.lines[0|a*s.scaleY*p],y=t.lines[0|a*t.scaleY*p],q=0;q<e;q++)m?(w=l[0|q*b.scaleX*r],h=c[0|q*s.scaleX*r],n=y[0|q*t.scaleX*r],f=E(w+1.402*(n-128)),C=E(w-0.3441363*(h-128)-0.71413636*(n-128)),w=E(w+1.772*(h-128))):(f=l[0|q*b.scaleX*r],C=c[0|q*s.scaleX*r],w=y[0|q*t.scaleX*r]),u[d++]=f,u[d++]=C,u[d++]=w;break;case 4:if(!this.adobe)throw"Unsupported color mode (4 components)";m=!1;this.adobe&&this.adobe.transformCode?m=!0:"undefined"!==typeof this.colorTransform&&(m=!!this.colorTransform);b=this.components[0];
s=this.components[1];t=this.components[2];f=this.components[3];for(a=0;a<k;a++)for(l=b.lines[0|a*b.scaleY*p],c=s.lines[0|a*s.scaleY*p],y=t.lines[0|a*t.scaleY*p],C=f.lines[0|a*f.scaleY*p],q=0;q<e;q++)m?(w=l[0|q*b.scaleX*r],h=c[0|q*s.scaleX*r],n=y[0|q*t.scaleX*r],v=C[0|q*f.scaleX*r],z=255-E(w+1.402*(n-128)),n=255-E(w-0.3441363*(h-128)-0.71413636*(n-128)),w=255-E(w+1.772*(h-128))):(z=l[0|q*b.scaleX*r],n=c[0|q*s.scaleX*r],w=y[0|q*t.scaleX*r],v=C[0|q*f.scaleX*r]),u[d++]=z,u[d++]=n,u[d++]=w,u[d++]=v;break;
default:throw"Unsupported color mode";}return u},copyToImageData:function(e){var k=e.width,r=e.height;e=e.data;var p=this.getData(k,r),b=0,s=0,t,f,l,c,y,C;switch(this.components.length){case 1:for(f=0;f<r;f++)for(t=0;t<k;t++)l=p[b++],e[s++]=l,e[s++]=l,e[s++]=l,e[s++]=255;break;case 3:for(f=0;f<r;f++)for(t=0;t<k;t++)y=p[b++],C=p[b++],l=p[b++],e[s++]=y,e[s++]=C,e[s++]=l,e[s++]=255;break;case 4:for(f=0;f<r;f++)for(t=0;t<k;t++)y=p[b++],C=p[b++],l=p[b++],c=p[b++],y=255-E(y*(1-c/255)+c),C=255-E(C*(1-c/
255)+c),l=255-E(l*(1-c/255)+c),e[s++]=y,e[s++]=C,e[s++]=l,e[s++]=255;break;default:throw"Unsupported color mode";}}};return R}();
