function GmailClipper(){function q(a){return a.replace(/(,{2,})/g,function(a){return a.split("").join("null")}).replace(/(\[,|,\])/g,function(a){return a.replace("[","[null").replace("]","null]")})}function r(a,e,f,c,g,h){var b=new XMLHttpRequest;b.open("POST",a);b.baseUrl=a;b.ik=e;b.threadId=f;b.numRetryMsgs=c.length;b.thread=g;b.threadingEnabled=h;b.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){for(var a=this.response.substr(this.response.search(/\d/)).split(/\d+\n/),
b=[],c=0;c<a.length;c++)if(!(""==a[c].trim()||0>a[c].indexOf('"ms"'))){var g=q(a[c]);try{for(var e=JSON.parse(g),f=0;f<e.length;f++){var d=e[f];if("ms"==d[0]&&2<=d[3]&&4>=d[3]){var h=d[1],l=new GmailMessage(this.baseUrl);d[13]?(l.setAuthorInfo(d[5],d[6]),this.thread.setSubject(d[13][21]),l.setBody(d[13][6]),this.thread.addParticipants([[d[5],d[6]]]),this.thread.addParticipants(d[13][9][1]),this.thread.addParticipants(d[13][9][0]),l.addAttachments(d[13][7][0]),l.setDate(d[24])):b.push(h);this.thread.addMessage(l,
h)}}}catch(n){log.error("\n"+n.stack);log.log(g);m(null,"could not parse. check console for more details");return}}0<b.length&&0===this.numRetryMsgs?r(this.baseUrl,this.ik,this.threadId,b,this.thread,this.threadingEnabled):(0<b.length&&this.thread.removeMessages(b),m(this.thread))}else log.error("could not download gmail thread "+this.threadId+" with ik="+this.ik+" because of ("+this.status+") "+this.response),m(null,"could not download gmail thread "+this.threadId+" with ik="+this.ik+" because of ("+
this.status+") "+this.response)};b.setRequestHeader("Content-type","application/x-www-form-urlencoded");a="ik="+b.ik+"&ui=2&view=cv&ser=1&th="+b.threadId+"&pcd=1&mb="+(b.threadingEnabled?"0":"1")+"&rt=c";a=0<c.length?a+("&msgs="+c.join(",")+"&search=inbox"):a+"&search=query";b.send(a)}function n(a,e,f){var c=new XMLHttpRequest;c.open("POST",a);c.baseUrl=a;c.ik=e;c.onreadystatechange=function(){if(4==this.readyState)if(200==this.status)try{var a=this.response.substr(this.response.search(/\d/)).split(/\d+\n/),
c=!0,b=0;a:for(;b<a.length;b++)if(!(""==a[b].trim()||0>a[b].indexOf('"p"'))){var e=JSON.parse(q(a[b])),k=0;for(;k<e.length;k++)if("p"==e[k][0]){var p=0;for(;p<e[k][1].length;p++)if("bx_vmb"==e[k][1][p][0]){c=0==e[k][1][p][1];break a}}}f(this.baseUrl,this.ik,c)}catch(n){log.error("could not parse the settings response.\n"+n.stack),log.log(this.response),m(null,"could not parse settings. check internal clipper logs for more details")}else log.error("could not download settings from baseUrl="+this.baseUrl+
", ik="+this.ik+" with status ("+this.status+") "+this.response),f(this.baseUrl,this.ik,!0)};c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.send("ik="+e+"&view=pu&rt=c")}var m;window.addEventListener("message",function(a){"receiveGmailIk"==a.data.name&&(/mail\/$/.test(a.data.baseUrl)&&(a.data.baseUrl+="u/0/"),n(a.data.baseUrl,a.data.ik,function(a,f,c){var g=/#.+?.*\/(.+?)($|\?)/.exec(window.location.href)[1],h=new GmailThread;r(a,f,g,[],h,c)}))});this.getThread=function(a){m=
a;a=document.createElement("script");a.id="evernoteGmailScript";a.innerText='window.postMessage({ name: "receiveGmailIk", baseUrl: window.GLOBALS[31], ik: window.GLOBALS[9] }, "*");document.body.removeChild(document.getElementById("evernoteGmailScript"));';document.body.appendChild(a)};Object.preventExtensions(this)}Object.preventExtensions(GmailClipper);
