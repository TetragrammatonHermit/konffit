var Jbig2Image=function(){function I(){}function G(a,p,n){this.data=a;this.start=p;this.end=n}function w(a,p,n){a=a.getContexts(p);for(var c=p=1,e=0,r,s=32,q=4436;c;){var m=a[p];m||(a[p]=m={index:0,mps:0});m=n.readBit(m);p=256>p?p<<1|m:(p<<1|m)&511|256;switch(c){case 1:r=!!m;break;case 2:if(m)break;c=7;s=2;q=0;break;case 3:if(m)break;c=7;q=s=4;break;case 4:if(m)break;c=7;s=6;q=20;break;case 5:if(m)break;c=7;s=8;q=84;break;case 6:if(m)break;c=7;s=12;q=340;break;default:e=2*e+m;0==--s&&(c=0);continue}c++}e+=
q;return r?0<e?-e:null:e}function J(a,p,n){a=a.getContexts("IAID");for(var c=1,e=0;e<n;e++){var r=a[c];r||(a[c]=r={index:0,mps:0});r=p.readBit(r);c=2*c+r}return 31>n?c&(1<<n)-1:c-Math.pow(2,n)}function K(a){for(var p=1,n=0;a>p;)p<<=1,n++;return n}function t(a,p){var n=a[p]<<24|a[p+1]<<16|a[p+2]<<8|a[p+3];return n&2147483648?n+4294967296:n}function L(a,p,n,c,e,r,s,q){a&&error("JBIG2 error: MMR encoding is not supported");a=!!r;var m=S[c].concat(s);s=m.length;for(var l=new Int32Array(s),d=new Int32Array(s),
b=0;b<s;b++)l[b]=m[b].x,d[b]=m[b].y;c=T[c];var m=[],g=q.decoder;q=q.contextCache.getContexts("GB");for(var k=0,f=0;f<n;f++)if(e&&((b=q[c])||(q[c]=b={index:0,mps:0}),b=g.readBit(b),k^=b),k)m.push(m[m.length-1]);else{var h=new Uint8Array(p);m.push(h);for(var u=0;u<p;u++)if(a&&r[f][u])h[u]=0;else{for(var D=0,b=0;b<s;b++)var x=f+d[b],v=u+l[b],D=0>x||0>v||v>=p?D<<1:D<<1|m[x][v];(b=q[D])||(q[D]=b={index:0,mps:0});b=g.readBit(b);h[u]=b}}return m}function M(a,p,n,c,e,r,s,q,m){var l=N[n].coding;0==n&&(l=l.concat([q[0]]));
for(var d=l.length,b=new Int32Array(d),g=new Int32Array(d),k=0;k<d;k++)b[k]=l[k].x,g[k]=l[k].y;var f=N[n].reference;0==n&&(f=f.concat([q[1]]));q=f.length;for(var l=new Int32Array(q),h=new Int32Array(q),k=0;k<q;k++)l[k]=f[k].x,h[k]=f[k].y;var f=c[0].length,u=c.length;n=U[n];var D=[],x=m.decoder;m=m.contextCache.getContexts("GR");for(var v=0,y=0;y<p;y++){s&&((k=m[n])||(m[n]=k={index:0,mps:0}),k=x.readBit(k),v^=k);var w=new Uint8Array(a);D.push(w);for(var t=0;t<a;t++){v&&error("JBIG2 error: prediction is not supported");
for(var z=0,k=0;k<d;k++)var A=y+g[k],B=t+b[k],z=0>A||0>B||B>=a?z<<1:z<<1|D[A][B];for(k=0;k<q;k++)A=y+h[k]+r,B=t+l[k]+e,z=0>A||A>=u||0>B||B>=f?z<<1:z<<1|c[A][B];(k=m[z])||(m[z]=k={index:0,mps:0});k=x.readBit(k);w[t]=k}}return D}function O(a,p){return{width:t(a,p),height:t(a,p+4),x:t(a,p+8),y:t(a,p+12),combinationOperator:a[p+16]&7}}function P(){}function Q(){}var V=function(){function a(a,c,e){this.data=a;this.bp=c;this.dataEnd=e;this.chigh=a[c];this.clow=0;this.byteIn();this.chigh=this.chigh<<7&65535|
this.clow>>9&127;this.clow=this.clow<<7&65535;this.ct-=7;this.a=32768}var p=[{qe:22017,nmps:1,nlps:1,switchFlag:1},{qe:13313,nmps:2,nlps:6,switchFlag:0},{qe:6145,nmps:3,nlps:9,switchFlag:0},{qe:2753,nmps:4,nlps:12,switchFlag:0},{qe:1313,nmps:5,nlps:29,switchFlag:0},{qe:545,nmps:38,nlps:33,switchFlag:0},{qe:22017,nmps:7,nlps:6,switchFlag:1},{qe:21505,nmps:8,nlps:14,switchFlag:0},{qe:18433,nmps:9,nlps:14,switchFlag:0},{qe:14337,nmps:10,nlps:14,switchFlag:0},{qe:12289,nmps:11,nlps:17,switchFlag:0},{qe:9217,
nmps:12,nlps:18,switchFlag:0},{qe:7169,nmps:13,nlps:20,switchFlag:0},{qe:5633,nmps:29,nlps:21,switchFlag:0},{qe:22017,nmps:15,nlps:14,switchFlag:1},{qe:21505,nmps:16,nlps:14,switchFlag:0},{qe:20737,nmps:17,nlps:15,switchFlag:0},{qe:18433,nmps:18,nlps:16,switchFlag:0},{qe:14337,nmps:19,nlps:17,switchFlag:0},{qe:13313,nmps:20,nlps:18,switchFlag:0},{qe:12289,nmps:21,nlps:19,switchFlag:0},{qe:10241,nmps:22,nlps:19,switchFlag:0},{qe:9217,nmps:23,nlps:20,switchFlag:0},{qe:8705,nmps:24,nlps:21,switchFlag:0},
{qe:7169,nmps:25,nlps:22,switchFlag:0},{qe:6145,nmps:26,nlps:23,switchFlag:0},{qe:5633,nmps:27,nlps:24,switchFlag:0},{qe:5121,nmps:28,nlps:25,switchFlag:0},{qe:4609,nmps:29,nlps:26,switchFlag:0},{qe:4353,nmps:30,nlps:27,switchFlag:0},{qe:2753,nmps:31,nlps:28,switchFlag:0},{qe:2497,nmps:32,nlps:29,switchFlag:0},{qe:2209,nmps:33,nlps:30,switchFlag:0},{qe:1313,nmps:34,nlps:31,switchFlag:0},{qe:1089,nmps:35,nlps:32,switchFlag:0},{qe:673,nmps:36,nlps:33,switchFlag:0},{qe:545,nmps:37,nlps:34,switchFlag:0},
{qe:321,nmps:38,nlps:35,switchFlag:0},{qe:273,nmps:39,nlps:36,switchFlag:0},{qe:133,nmps:40,nlps:37,switchFlag:0},{qe:73,nmps:41,nlps:38,switchFlag:0},{qe:37,nmps:42,nlps:39,switchFlag:0},{qe:21,nmps:43,nlps:40,switchFlag:0},{qe:9,nmps:44,nlps:41,switchFlag:0},{qe:5,nmps:45,nlps:42,switchFlag:0},{qe:1,nmps:45,nlps:43,switchFlag:0},{qe:22017,nmps:46,nlps:46,switchFlag:0}];a.prototype={byteIn:function(){var a=this.data,c=this.bp;255==a[c]?143<a[c+1]?(this.clow+=65280,this.ct=8):(c++,this.clow+=a[c]<<
9,this.ct=7,this.bp=c):(c++,this.clow+=c<this.dataEnd?a[c]<<8:65280,this.ct=8,this.bp=c);65535<this.clow&&(this.chigh+=this.clow>>16,this.clow&=65535)},readBit:function(a){var c=p[a.index].qe;this.a-=c;if(this.chigh<c)return a=this.exchangeLps(a),this.renormD(),a;this.chigh-=c;return 0==(this.a&32768)?(a=this.exchangeMps(a),this.renormD(),a):a.mps},renormD:function(){do 0==this.ct&&this.byteIn(),this.a<<=1,this.chigh=this.chigh<<1&65535|this.clow>>15&1,this.clow=this.clow<<1&65535,this.ct--;while(0==
(this.a&32768))},exchangeMps:function(a){var c,e=p[a.index];this.a<e.qe?(c=1-a.mps,1==e.switchFlag&&(a.mps=1-a.mps),a.index=e.nlps):(c=a.mps,a.index=e.nmps);return c},exchangeLps:function(a){var c,e=p[a.index];this.a<e.qe?(this.a=e.qe,c=a.mps,a.index=e.nmps):(this.a=e.qe,c=1-a.mps,1==e.switchFlag&&(a.mps=1-a.mps),a.index=e.nlps);return c}};return a}();I.prototype={getContexts:function(a){return a in this?this[a]:this[a]=[]}};G.prototype={get decoder(){var a=new V(this.data,this.start,this.end);return shadow(this,
"decoder",a)},get contextCache(){var a=new I;return shadow(this,"contextCache",a)}};var R=["SymbolDictionary",null,null,null,"IntermediateTextRegion",null,"ImmediateTextRegion","ImmediateLosslessTextRegion",null,null,null,null,null,null,null,null,"patternDictionary",null,null,null,"IntermediateHalftoneRegion",null,"ImmediateHalftoneRegion","ImmediateLosslessHalftoneRegion",null,null,null,null,null,null,null,null,null,null,null,null,"IntermediateGenericRegion",null,"ImmediateGenericRegion","ImmediateLosslessGenericRegion",
"IntermediateGenericRefinementRegion",null,"ImmediateGenericRefinementRegion","ImmediateLosslessGenericRefinementRegion",null,null,null,null,"PageInformation","EndOfPage","EndOfStripe","EndOfFile","Profiles","Tables",null,null,null,null,null,null,null,null,"Extension"],S=[[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:2,y:-1},{x:-4,y:0},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}],[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:2,y:-1},
{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}],[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-2,y:0},{x:-1,y:0}],[{x:-3,y:-1},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-4,y:0},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}]],N=[{coding:[{x:0,y:-1},{x:1,y:-1},{x:-1,y:0}],reference:[{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1}]},{coding:[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0}],reference:[{x:0,y:-1},{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:0,y:1},
{x:1,y:1}]}],T=[7379,1946,227,395],U=[32,8];P.prototype={onPageInformation:function(a){this.currentPageInfo=a;var p=new Uint8Array((a.width+7>>3)*a.height);a=a.defaultPixelValue?255:0;for(var n=0,c=p.length;n<c;n++)p[n]=a;this.buffer=p},drawBitmap:function(a,p){for(var n=this.currentPageInfo,c=a.width,e=a.height,r=n.width+7>>3,n=n.combinationOperatorOverride?a.combinationOperator:n.combinationOperator,s=this.buffer,q=0;q<e;q++){var m=128>>(a.x&7),l=(q+a.y)*r+(a.x>>3);switch(n){case 0:for(var d=0;d<
c;d++)s[l]|=p[q][d]?m:0,m>>=1,m||(m=128,l++);break;case 2:for(d=0;d<c;d++)s[l]^=p[q][d]?m:0,m>>=1,m||(m=128,l++);break;default:error("JBIG2 error: operator "+n+" is not supported")}}},onImmediateGenericRegion:function(a,p,n,c){var e=a.info;p=new G(p,n,c);a=L(a.mmr,e.width,e.height,a.template,a.prediction,null,a.at,p);this.drawBitmap(e,a)},onImmediateLosslessGenericRegion:function(){this.onImmediateGenericRegion.apply(this,arguments)},onSymbolDictionary:function(a,p,n,c,e,r){a.huffman&&error("JBIG2 error: huffman is not supported");
var s=this.symbols;s||(this.symbols=s={});for(var q=[],m=0,l=n.length;m<l;m++)q=q.concat(s[n[m]]);r=new G(c,e,r);m=a.refinement;n=q;var q=a.numberOfNewSymbols,l=a.template,d=a.at,b=a.refinementTemplate,g=a.refinementAt;a.huffman&&error("JBIG2 error: huffman is not supported");a=[];var k=0,f=K(n.length+q);c=r.decoder;for(e=r.contextCache;a.length<q;)for(var h=w(e,"IADH",c),k=k+h,h=0;;){var u=w(e,"IADW",c);if(null==u)break;h+=u;if(m){1<w(e,"IAAI",c)&&error("JBIG2 error: number of instances > 1 is not supported");
var u=J(e,c,f),t=w(e,"IARDX",c),x=w(e,"IARDY",c),u=M(h,k,b,u<n.length?n[u]:a[u-n.length],t,x,!1,g,r)}else u=L(!1,h,k,l,!1,null,d,r);a.push(u)}r=[];m=[];l=!1;for(d=n.length+q;m.length<d;){for(b=w(e,"IAEX",c);b--;)m.push(l);l=!l}c=0;for(e=n.length;c<e;c++)m[c]&&r.push(n[c]);for(n=0;n<q;c++,n++)m[c]&&r.push(a[n]);s[p]=r},onImmediateTextRegion:function(a,p,n,c,e){for(var r=a.info,s=this.symbols,q=[],m=0,l=p.length;m<l;m++)q=q.concat(s[p[m]]);p=K(q.length);n=new G(n,c,e);c=a.refinement;var d=r.width,b=
r.height,g=a.defaultPixelValue;e=a.numberOfSymbolInstances;var s=a.stripSize,k=a.transposed,m=a.dsOffset,l=a.referenceCorner,f=a.combinationOperator,h=a.refinementTemplate,u=a.refinementAt;a.huffman&&error("JBIG2 error: huffman is not supported");a=[];for(var t=0;t<b;t++){var x=new Uint8Array(d);if(g)for(var v=0;v<d;v++)x[v]=g;a.push(x)}d=n.decoder;b=n.contextCache;k&&error("JBIG2 error: transposed is not supported");k=-w(b,"IADT",d);for(t=g=0;t<e;){v=w(b,"IADT",d);k+=v;v=w(b,"IAFS",d);v=g+=v;do{var y=
1==s?0:w(b,"IAIT",d),x=s*k+y,y=J(b,d,p),F=c&&w(b,"IARI",d),y=q[y],E=y[0].length,z=y.length;if(F)var F=w(b,"IARDW",d),A=w(b,"IARDH",d),B=w(b,"IARDX",d),H=w(b,"IARDY",d),E=E+F,z=z+A,y=M(E,z,h,y,(F>>1)+B,(A>>1)+H,!1,u,n);F=x-(l&1?0:z);A=v-(l&2?E:0);for(B=0;B<z;B++)if(x=a[F+B])switch(H=y[B],f){case 0:for(var C=0;C<E;C++)x[A+C]|=H[C];break;case 2:for(C=0;C<E;C++)x[A+C]^=H[C];break;default:error("JBIG2 error: operator "+f+" is not supported")}v+=E-1;t++;y=w(b,"IADS",d);if(null==y)break;v+=y+m}while(1)}this.drawBitmap(r,
a)},onImmediateLosslessTextRegion:function(){this.onImmediateTextRegion.apply(this,arguments)}};Q.prototype={parseChunks:function(a){for(var p=new P,n=0,c=a.length;n<c;n++){for(var e=a[n],r={},s=e.data,q=e.end,m=[],l=e.start;l<q;){var e=s,d=l,l={};l.number=t(e,d);var b=e[d+4],g=b&63;R[g]||error("JBIG2 error: invalid segment type: "+g);l.type=g;l.typeName=R[g];l.deferredNonRetain=!!(b&128);var b=!!(b&64),k=e[d+5],g=k>>5&7,f=[k&31],d=d+6;if(7==k)for(g=(e[d-1]<<24|e[d-1+1]<<16|e[d-1+2]<<8|e[d-1+3])&
536870911,d+=3,k=g+7>>3,f[0]=e[d++];0<--k;)f.push(e[d++]);else 5!=k&&6!=k||error("JBIG2 error: invalid referred-to flags");l.retainBits=f;for(var f=256>=l.number?1:65536>=l.number?2:4,k=[],h=0;h<g;h++){var u=1==f?e[d]:2==f?e[d]<<8|e[d+1]:t(e,d);k.push(u);d+=f}l.referredTo=k;b?(l.pageAssociation=t(e,d),d+=4):l.pageAssociation=e[d++];l.length=t(e,d);4294967295==l.length&&error("JBIG2 error: unknown segment length is not supported");d+=4;l.headerEnd=d;e=l;l=e.headerEnd;b={header:e,data:s};r.randomAccess||
(b.start=l,l+=e.length,b.end=l);m.push(b);if(51==e.type)break}if(r.randomAccess)for(r=0,s=m.length;r<s;r++)m[r].start=l,l+=m[r].header.length,m[r].end=l;r=p;s=0;for(q=m.length;s<q;s++){d=m[s];e=r;l=d.header;b=d.data;g=d.start;d=d.end;f=void 0;switch(l.type){case 0:h={};f=b[g]<<8|b[g+1];h.huffman=!!(f&1);h.refinement=!!(f&2);h.huffmanDHSelector=f>>2&3;h.huffmanDWSelector=f>>4&3;h.bitmapSizeSelector=f>>6&1;h.aggregationInstancesSelector=f>>7&1;h.bitmapCodingContextUsed=!!(f&256);h.bitmapCodingContextRetained=
!!(f&512);h.template=f>>10&3;h.refinementTemplate=f>>12&1;g+=2;if(!h.huffman){u=0==h.template?4:1;f=[];for(k=0;k<u;k++)f.push({x:b[g]<<24>>24,y:b[g+1]<<24>>24}),g+=2;h.at=f}if(h.refinement&&!h.refinementTemplate){f=[];for(k=0;2>k;k++)f.push({x:b[g]<<24>>24,y:b[g+1]<<24>>24}),g+=2;h.refinementAt=f}h.numberOfExportedSymbols=t(b,g);g+=4;h.numberOfNewSymbols=t(b,g);g+=4;f=[h,l.number,l.referredTo,b,g,d];break;case 6:case 7:h={};h.info=O(b,g);g+=17;f=b[g]<<8|b[g+1];g+=2;h.huffman=!!(f&1);h.refinement=
!!(f&2);h.stripSize=1<<(f>>2&3);h.referenceCorner=f>>4&3;h.transposed=!!(f&64);h.combinationOperator=f>>7&3;h.defaultPixelValue=f>>9&1;h.dsOffset=f>>10&31;h.refinementTemplate=f>>15&1;h.huffman&&(f=b[g]<<8|b[g+1],g+=2,h.huffmanFS=f&3,h.huffmanDS=f>>2&3,h.huffmanDT=f>>4&3,h.huffmanRefinementDW=f>>6&3,h.huffmanRefinementDH=f>>8&3,h.huffmanRefinementDX=f>>10&3,h.huffmanRefinementDY=f>>12&3,h.huffmanRefinementSizeSelector=!!(f&14));if(h.refinement&&!h.refinementTemplate){f=[];for(k=0;2>k;k++)f.push({x:b[g]<<
24>>24,y:b[g+1]<<24>>24}),g+=2;h.refinementAt=f}h.numberOfSymbolInstances=t(b,g);g+=4;h.huffman&&error("JBIG2 error: huffman is not supported");f=[h,l.referredTo,b,g,d];break;case 38:case 39:h={};h.info=O(b,g);g+=17;f=b[g++];h.mmr=!!(f&1);h.template=f>>1&3;h.prediction=!!(f&8);if(!h.mmr){u=0==h.template?4:1;f=[];for(k=0;k<u;k++)f.push({x:b[g]<<24>>24,y:b[g+1]<<24>>24}),g+=2;h.at=f}f=[h,b,g,d];break;case 48:d={width:t(b,g),height:t(b,g+4),resolutionX:t(b,g+8),resolutionY:t(b,g+12)};4294967295==d.height&&
delete d.height;b=b[g+16];d.lossless=!!(b&1);d.refinement=!!(b&2);d.defaultPixelValue=b>>2&1;d.combinationOperator=b>>3&3;d.requiresBuffer=!!(b&32);d.combinationOperatorOverride=!!(b&64);f=[d];break;case 50:break;case 51:break;default:error("JBIG2 error: segment type "+l.typeName+"("+l.type+") is not implemented")}l="on"+l.typeName;l in e&&e[l].apply(e,f)}}return p.buffer}};return Q}();
