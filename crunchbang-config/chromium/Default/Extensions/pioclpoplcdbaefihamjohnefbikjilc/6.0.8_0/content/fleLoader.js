(function(){function f(){return window===window.parent&&/^((www|stage|stage-corp|stage-china)\.)?(evernote|yinxiang)\.com$/i.test(document.location.host)&&/^.*?\/webclipper\/whats_new\/?$/i.test(document.location.pathname)&&"?firstlaunch"===document.location.search.toLowerCase()}function m(){this.removeEventListener("click",arguments.callee);var a=document.querySelector("#webclipper-fle-markup");a.addEventListener("webkitTransitionEnd",n);a.style.opacity="0"}function n(){this.removeEventListener("webkitTransitionEnd",
arguments.callee);this.style.display="none";g||(document.querySelector("#evernoteGlobalTools").className="canFit evernoteClipperVisible",d&&(d.style.visibility="visible"),b.style.display="block",b.contentWindow.postMessage({name:"taskFinished",type:"markup"},Browser.extension.getURL("")),g=!0)}function p(a,b,d){b=document.createElement("div");b.id="webclipper-fle-markup";b.innerHTML=a.response;GlobalUtils.localize(b);document.documentElement.appendChild(b);SAFARI&&(a=document.createElement("link"),
a.rel="stylesheet",a.href=Browser.extension.getURL("content/fle/flemarkup.css"),document.documentElement.appendChild(a));b.style.opacity="1";b.querySelector(".next-button").addEventListener("click",m)}function q(a,d,c){document.querySelector("#evernoteGlobalTools").style.zIndex="0";b=document.createElement("IFRAME");b.id="evernoteFlePage";b.src=Browser.extension.getURL("content/fle/fle.html");b.seamless=!0;document.documentElement.appendChild(b)}function r(a,d,c){b.contentWindow.postMessage({name:"taskFinished",
type:a.type},Browser.extension.getURL(""))}function c(){!h&&e&&(h=!0,Browser.sendToExtension({name:"tourLoaded"}))}var b,g=!1,d,e="undefined"===typeof document.hidden?!0:!document.hidden,h=!1,l;f()&&(window.addEventListener("unload",function(){Browser.sendToExtension({name:"finishTour"})}),document.addEventListener("visibilitychange",function(){e=!document.hidden||e;c()}),Browser.addMessageHandlers({receiveXMLHttpRequest:p,startTour:q,taskFinished:r}),window.addEventListener("message",function(a){if("eventDetected"==
a.data.name)b.contentWindow.postMessage(a.data,Browser.extension.getURL(""));else if("fleMarkUp"==a.data.name)b&&f()&&(d=document.querySelector(".skitch-surface"),Browser.sendToExtension({name:"loadXMLHttpRequest",url:Browser.extension.getURL("content/fle/flemarkup.html")}),b.style.display="none");else if("redirect"==a.data.name)Browser.sendToExtension({name:"finishTour"}),document.location.replace(document.location.protocol+"//"+document.location.host+document.location.pathname+"?firstlaunchreturn");
else if("getLocation"==a.data.name){a={name:"getLocationReply",location:{}};for(k in location){var c=location[k];"string"==typeof c&&(a.location[k]=c)}b.contentWindow.postMessage(a,Browser.extension.getURL(""))}else"screenshotDoneForFle"==a.data.name&&b.contentWindow.postMessage({name:"taskFinished",type:"screenshot"},Browser.extension.getURL(""))}),document.querySelector("#evernoteGlobalTools")?c():l=window.setInterval(function(){document.querySelector("#evernoteGlobalTools")&&(window.clearInterval(l),
c())},100))})();
