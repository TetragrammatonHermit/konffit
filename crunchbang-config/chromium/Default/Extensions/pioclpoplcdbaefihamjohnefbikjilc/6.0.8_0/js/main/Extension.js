function Extension(){var M,G;function Y(a){a?Z||(Z=!0,Persistent.get("localStoragePurged")||(Persistent.set("localStoragePurged",!0),delete localStorage.savedAuthInfo,delete localStorage.userCache),l=new BootstrapInfo(options.get("overrideServiceURL")),k=new Auth(options.get("overrideServiceURL"),options.get("secureProto")),!C&&k&&(C=new UsageMetricsManager(options.get("secureProto")+l.get("serviceHost"),k.isAuthenticated,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL"))),
$(),/^5\./.test(versionDetect.getLastVersion())&&/^6\./.test(versionDetect.getSourceVersion())&&k.logoutAll(),firstTime.startUp(),O(),ta(),firstTime.msgHandlerOnInit(function(){O()}),N({startup:!0}),Persistent.get("deviceID")||Persistent.set("deviceID",UUID.generateGuid().slice(0,32))):log.warn("Version out of date!")}function $(){SAFARI||P||(P=!0,chrome.contextMenus.removeAll(function(){ua()}))}function D(){alert(Browser.i18n.getMessage("contextMenuPleaseLogin"))}function va(a){var c=safari.application.activeBrowserWindow.activeTab,
b=a.userInfo;switch(a.command){case m.clipPage:aa(c);break;case m.clipScreenshot:ba(c);break;case m.clipSelection:ca(b,c);break;case m.clipImage:da(b,c);break;case m.clipPDF:ea(c);break;case m.clipUrl:fa(c)}}function wa(a){var c=a.userInfo;if(!c||!c.url||c.url.match(/^https?/i)&&!c.url.match(/^https?:\/\/extensions.apple.com/i))a.contextMenu.appendContextMenuItem(m.clipPage,Browser.i18n.getMessage("safariContextClipPage"),m.clipPage),a.contextMenu.appendContextMenuItem(m.clipScreenshot,Browser.i18n.getMessage("safariContextClipScreenshot"),
m.clipScreenshot),a.userInfo&&a.userInfo.selection&&a.contextMenu.appendContextMenuItem(m.clipSelection,Browser.i18n.getMessage("safariContextClipSelection"),m.clipSelection),a.userInfo&&a.userInfo.node&&"img"==a.userInfo.node.toLowerCase()&&a.contextMenu.appendContextMenuItem(m.clipImage,Browser.i18n.getMessage("safariContextClipImage"),m.clipImage),a.userInfo&&a.userInfo.pdf&&a.contextMenu.appendContextMenuItem(m.clipPDF,Browser.i18n.getMessage("safariContextClipPDF"),m.clipPDF),a.contextMenu.appendContextMenuItem(m.clipUrl,
Browser.i18n.getMessage("safariContextClipUrl"),m.clipUrl)}function t(a){return a.bizAuthenticationToken?"business":a.premium?"premium":"free"}function aa(a){C.recordActivity(k.isAuthenticated);E(a.url)||k.isAuthenticated(function(c){c?Browser.sendToTab(a,{name:"clipFullPage",userId:c.userId,userType:t(c)}):D()})}function ba(a){C.recordActivity(k.isAuthenticated);E(a.url)||k.isAuthenticated(function(c){c?ga({contextMenu:!0},{tab:a}):D()})}function ca(a,c){C.recordActivity(k.isAuthenticated);E(c.url)||
k.isAuthenticated(function(b){if(b)if(OPERA&&Q(c.url)){var d=UUID.generateGuid();H({noteFilingInfo:{title:c.title||Browser.i18n.getMessage("quickNote_untitledNote"),type:"pers",url:R(c.url)},pendingNoteKey:d,userId:b.userId,userType:t(b)},{tab:c});I({clipType:"selection",html:a.selectionText,pendingNoteKey:d,userId:b.userId,userType:t(b)},{tab:c})}else Browser.sendToTab(c,{name:"clipSelection",selectionText:a.selectionText,userId:b.userId,userType:t(b)});else D()})}function da(a,c){C.recordActivity(k.isAuthenticated);
E(c.url)||k.isAuthenticated(function(b){b?Browser.sendToTab(c,{name:"clipImage",imageUrl:a.srcUrl,userId:b.userId,userType:t(b)}):D()})}function ea(a){C.recordActivity(k.isAuthenticated);E(a.url)||k.isAuthenticated(function(c){if(c)if(OPERA&&Q(a.url)){var b=UUID.generateGuid(),d=R(a.url);H({noteFilingInfo:{title:a.title||Browser.i18n.getMessage("quickNote_untitledNote"),type:"pers",url:d},pendingNoteKey:b,userId:c.userId,userType:t(c)},{tab:a});I({clipType:"pdf",html:'<embed src="'+d+'" type="application/pdf"></embed>',
pendingNoteKey:b,userId:c.userId,userType:t(c)},{tab:a})}else Browser.sendToTab(a,{name:"clipPdf",userId:c.userId,userType:t(c)});else D()})}function fa(a){C.recordActivity(k.isAuthenticated);E(a.url)||k.isAuthenticated(function(c){if(c)if(OPERA&&Q(a.url)){var b=UUID.generateGuid(),d=R(a.url);H({noteFilingInfo:{title:a.title||Browser.i18n.getMessage("quickNote_untitledNote"),type:"pers",url:d},pendingNoteKey:b,userId:c.userId,userType:t(c)},{tab:a});I({clipType:"url",html:GlobalUtils.createTitleAndLinkPortionOfUrlClipContent(a.title,
d).content.outerHTML,pendingNoteKey:b,userId:c.userId,userType:t(c)},{tab:a})}else Browser.sendToTab(a,{name:"clipUrl",userId:c.userId,userType:t(c)});else D()})}function ua(){P=!1;var a=["http://*/*","https://*/*"],c=["http://*/*","https://*/*","chrome-extension://encfpfilknmenlmjemepncnlbbjlabkc/*","chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/*"];chrome.contextMenus.create({id:"fullPage",title:Browser.i18n.getMessage("contextMenuClipPage"),contexts:["page","image","selection"],documentUrlPatterns:a});
chrome.contextMenus.create({id:"screenshot",title:Browser.i18n.getMessage("contextMenuClipScreenshot"),contexts:["page","image","selection"],documentUrlPatterns:a});chrome.contextMenus.create({id:"selection",title:Browser.i18n.getMessage("contextMenuClipSelection"),contexts:["selection"],documentUrlPatterns:c});chrome.contextMenus.create({id:"image",title:Browser.i18n.getMessage("contextMenuClipImage"),contexts:["image"],targetUrlPatterns:a});chrome.contextMenus.create({id:"pdf",title:Browser.i18n.getMessage("contextMenuClipPDF"),
contexts:["all"],documentUrlPatterns:c});chrome.contextMenus.create({id:"url",title:Browser.i18n.getMessage("contextMenuClipUrl"),contexts:["all"],documentUrlPatterns:c});chrome.contextMenus.onClicked.addListener(function(a,c){switch(a.menuItemId){case "fullPage":aa(c);break;case "screenshot":ba(c);break;case "selection":ca(a,c);break;case "image":da(a,c);break;case "pdf":ea(c);break;case "url":fa(c)}})}function O(){if(SAFARI){var a=function(a,b){if(a&&"clipper"==a.identifier){b&&!/login\.html/.test(a.contentWindow.location.href)&&
(a.contentWindow.location.href=S);var d=a.contentWindow.location.href;/login\.html/.test(d)?(1<ha()?a.height=365:a.height=336,a.width=313):/registration\.html/.test(d)?(a.width=589,a.height=440):/two_factor\.html/.test(d)&&(a.width=313,a.height=325)}};safari.application.removeEventListener("validate",function(c){a(c.target.popover)});safari.application.addEventListener("validate",function(c){a(c.target.popover)});safari.application.removeEventListener("popover",function(c){a(c.target,!0)});safari.application.addEventListener("popover",
function(c){a(c.target,!0)})}firstTime.needToShowIntro()?(Browser.setPopup(""),Browser.setBrowserActionClickHandler(function(a){firstTime.msgHandlerOnAction(function(){O()})})):k.isAuthenticated(function(a){a?(Browser.setPopup(""),Browser.setBrowserActionClickHandler(function(a){k.isAuthenticated(function(c){c?ia(a)?(c=ja("marketingUrl")+"/webclipper/guide",Browser.closeTab(a),J=K=null,ka(c,function(a){xa(a,function(a){F(null,{tab:a})})})):F(null,{tab:a}):log.warn("logged out while toggling coordinator")})})):
(Browser.removeBrowserActionClickHandler(),Browser.setPopup(S))})}function xa(a,c){M=a.id;G=c}function ta(){function a(a){SAFARI?(N(),a.target.browserWindow?Browser.sendToTab(a.target,{name:"isExtensionOpen"}):a.target.activeTab&&Browser.sendToTab(a.target.activeTab,{name:"isExtensionOpen"})):(N(),Browser.sendToTab({id:a.tabId},{name:"isExtensionOpen"}))}SAFARI?safari.application.addEventListener("activate",a,!0):(chrome.tabs.onActivated.addListener(a),chrome.windows.onFocusChanged.addListener(function(c){chrome.tabs.query({active:!0,
windowId:c},function(c){c&&0<c.length?a({tabId:c[0].id}):log.warn("chrome tabs query did not return a result while changing window focus")})}))}function ia(a){return"undefined"===typeof K||"undefined"===typeof J?!1:a.id===K&&a.url===J}function F(a,c,b){k.isAuthenticated(function(a){if(a){var b={pers:a.authenticationToken};a.bizAuthenticationToken&&(b.biz=a.bizAuthenticationToken);Browser.sendToTab(c.tab,{name:"insertSerializationScripts"});Browser.sendToTab(c.tab,{name:"setFavIconUrl",favIconUrl:c.tab.favIconUrl?
c.tab.favIconUrl:"http://www.google.com/s2/favicons?domain="+encodeURIComponent(c.tab.url)});Browser.sendToTab(c.tab,{name:"toggleCoordinator",baseUrl:options.get("secureProto")+l.get("serviceHost"),userId:a.userId,username:a.username,authTokens:b,premium:a.premium,fullName:a.fullName,alwaysTags:options.get("alwaysTagWith")?options.get("alwaysTags"):null})}else log.error("logged out while toggling clipper.")})}function la(a,c,b,d,f){var y=[],e=Math.max(3-a.length,2),k=[],y=[];a||(a=[]);b||(b=[]);
for(var h=0;h<b.length&&!(k.length>=e&&y.length>=e);h++)b[h].inBusinessNotebook=!0,f[b[h].notebookGuid].joined?k.push(b[h]):(b[h].notebookName=f[b[h].notebookGuid].name,b[h].contact=b[h].attributes.lastEditedBy||b[h].attributes.author||f[b[h].notebookGuid].contact,y.push(b[h]));h=Math.min(e,k.length);h=Math.max(e-h,1);b=Math.min(h,y.length);e=k.slice(0,e-b);for(h=0;h<b;h++)e.push(y[h]);y=a.slice(0,3-e.length);for(h=0;h<e.length;h++)y.push(e[h]);for(h=0;h<y.length;h++)y[h].shardId=y[h].inBusinessNotebook?
d:c;return y}function T(){Browser.setTitle(Browser.i18n.getMessage("webClipperUpdated"));Browser.setIcon("images/wc6-update")}function U(){firstTime.isUpgraded()?T():(Browser.setTitle(Browser.i18n.getMessage("BrowserActionTitle")),Browser.setIcon("images/web-clipper"))}function ma(){firstTime.isUpgraded()?T():(Browser.setTitle(Browser.i18n.getMessage("signInPrompt")),Browser.setIcon("images/web-clipper-sign-in"))}function N(a,c,b){firstTime.isUpgraded()?T():k.isAuthenticated(function(c){c?a&&a.startup||
U():ma()})}function L(){var a=Object.keys(e).length;if(SAFARI)for(var c=0;c<safari.extension.toolbarItems.length;c++)safari.extension.toolbarItems[c].badge=a;else chrome.browserAction.setBadgeBackgroundColor({color:[255,255,0,255]}),0==a?chrome.browserAction.setBadgeText({text:""}):chrome.browserAction.setBadgeText({text:a.toString()})}function Q(a){return/^chrome-extension:\/\/(encfpfilknmenlmjemepncnlbbjlabkc|oemmndcbldboiebfnladdacbdfmadadm)\//.test(a)}function R(a){return/^chrome-extension:\/\/(encfpfilknmenlmjemepncnlbbjlabkc|oemmndcbldboiebfnladdacbdfmadadm)\/(.+)/.exec(a)[2]}
function E(a){a=(a+"").toLowerCase();a=a.match(/^https?:\/\/chrome.google.com\/(extensions|webstore)/)?!0:!1;return a?(alert(Browser.i18n.getMessage("illegalUrlClipFailure")),!0):!1}function na(a,c,b){log.log("Got restart message...");Browser.removeMessageHandlers();window.location.reload()}function oa(a,c,b){function d(b){if("simSearch"==a.type)Browser.sendToTab(c.tab,{name:"simSearch_isAuthenticated",auth:b});else if("clipResult"==a.type)Browser.sendToTab(c.tab,{name:"clipResult_isAuthenticated",
auth:b});else if("options"==a.type)Browser.sendToTab(c.tab,{name:"options_isAuthenticated",auth:b,option:a.option});else if("pdfTooltip"==a.type){var d=Persistent.get(b.userId+"_pdfTooltipShown");Persistent.set(b.userId+"_pdfTooltipShown",!0);Browser.sendToTab(c.tab,{name:"pdfTooltip_isAuthenticated",auth:b,pdfTooltipShown:d})}else if("tooltip"==a.type){b={name:"tooltip_isAuthenticated",auth:b};if(a.bootstrapInfo)for(d in b.bootstrapInfo={},a.bootstrapInfo)b.bootstrapInfo[d]=l.get(d);Browser.sendToTab(c.tab,
b)}}c&&c.tab?k.isAuthenticated(d):k.isAuthenticated(b)}function V(a,c,b){k.logoutAll(a.authExpired);Browser.sendToTab(c.tab,{name:"logoutCallback"});Browser.removeBrowserActionClickHandler();Browser.setPopup(S)}function ja(a){return l?l.get(a):""}function ha(){return l?l.getLength():0}function pa(a,c,b){ka(a.url);b&&b()}function ka(a,c){if(SAFARI){var b=safari.application.activeBrowserWindow.openTab();b.url=a;c&&c(b)}else chrome.tabs.create({url:a,selected:!0},c)}function qa(a,c,b){var d=600,f=600;
c="";a.width&&(d=a.width);a.height&&(f=a.height);a.url&&(c=a.url);c&&(a={url:c,width:d,height:f,type:a.type},SAFARI?safari.application.openBrowserWindow().activeTab.url=c:chrome.windows.create(a));b&&b()}function ra(a,c,b){try{C.recordActivity()}catch(d){log.error("Failed to record user activity: "+d.trace||d.stack||JSON.stringify(d))}b&&b()}function ga(a,c,b){Browser.sendToTab(c.tab,{name:"hideScrollbar"});a.contextMenu?Browser.sendToTab(c.tab,{name:"toggleCoordinator",for:"screenshot",contextMenu:!0}):
Browser.sendToTab(c.tab,{name:"hideCoordinator",for:"screenshot",tool:a.tool,showSubtools:a.showSubtools})}function W(a,c,b){c=document.getElementById("temp-textarea");c||(c=document.createElement("textarea"),c.id="temp-textarea",document.body.appendChild(c));c.value=a.text;c.select();document.execCommand("copy",!1,null)}function I(a,c,b){e[a.pendingNoteKey]||(e[a.pendingNoteKey]=new PendingNote);L();"skitch"==a.clipType?b=a.content:(b='<br/><div style="position: relative;',a.width&&parseInt(a.width)&&
(b+=" max-width: "+a.width+";"),b+='">'+a.html+"</div><br/>",b=GlobalUtils.removeControlCharacters(b));e[a.pendingNoteKey].content=b;e[a.pendingNoteKey].resources=a.resources;e[a.pendingNoteKey].share=a.share;e[a.pendingNoteKey].updateGuid=a.updateGuid;e[a.pendingNoteKey].previousToken=a.previousToken;e[a.pendingNoteKey].recommendationText=a.recommendationText;e[a.pendingNoteKey].notDualLink=Boolean(a.hasTextHighlights)||-1<["clearly","email","pdf","skitch"].indexOf(a.clipType);"clearly"==a.clipType&&
(a.contentClass="Clearly");Analytics.trackEvent(a.userId,"Clip Type",a.clipType,a.userType);e[a.pendingNoteKey].filingInfo?(e[a.pendingNoteKey].filingInfo.contentClass=a.contentClass,X(a.pendingNoteKey,c.tab||c.sender.tab)):e[a.pendingNoteKey].tempContentClass=a.contentClass}function H(a,c,b){e[a.pendingNoteKey]||(e[a.pendingNoteKey]=new PendingNote);L();e[a.pendingNoteKey].relatedNotes=a.noteFilingInfo.relatedNotes;delete a.noteFilingInfo.relatedNotes;e[a.pendingNoteKey].filingInfo=a.noteFilingInfo;
e[a.pendingNoteKey].filingInfo.contentClass=e[a.pendingNoteKey].tempContentClass;delete e[a.pendingNoteKey].tempContentClass;e[a.pendingNoteKey].originatingTab=c.tab||c.sender.tab;Analytics.trackEvent(a.userId,"Comments",a.noteFilingInfo.comment?"added comments":"did not add comments",a.userType,a.noteFilingInfo.comment?a.noteFilingInfo.comment.length:null);Analytics.trackEvent(a.userId,"Tags",a.noteFilingInfo.tagNames&&0<a.noteFilingInfo.tagNames.length?"added tags":"did not add tags",a.userType,
a.noteFilingInfo.tagNames&&0<a.noteFilingInfo.tagNames.length?a.noteFilingInfo.tagNames.length:null);ya({pendingNoteKey:a.pendingNoteKey},c);e[a.pendingNoteKey].content&&X(a.pendingNoteKey,c.tab||c.sender.tab)}function X(a,c){var b=options.get("secureProto")+l.get("serviceHost");k.isAuthenticated(function(d){var f;"pers"==e[a].filingInfo.type?f=d.authenticationToken:"linked"==e[a].filingInfo.type?f=e[a].filingInfo.auth:"biz"==e[a].filingInfo.type&&(f=d.bizAuthenticationToken);(new Submitter({submit:f,
pers:d.authenticationToken,previous:e[a].previousToken},k.getUserInfo().premium,e[a].updateGuid,b,c,k.getCurrentUser(),function(b){b&&(e[a].share?(za({auth:f,guid:b.guid,noteSize:b.noteSize,shardId:b.shardId,source:e[a].notDualLink?null:e[a].filingInfo.url},{tab:c}),e[a].updateGuid?Analytics.trackEvent(k.getCurrentUser(),"share and save","share (update)",t(d)):Analytics.trackEvent(k.getCurrentUser(),"share and save","share (first time)",t(d))):e[a].updateGuid?Analytics.trackEvent(k.getCurrentUser(),
"share and save","save (after share)",t(d)):Analytics.trackEvent(k.getCurrentUser(),"share and save","save (no share)",t(d)));delete e[a];L()})).createNoteWithThrift(e[a].filingInfo,e[a].content,e[a].resources)},!0)}function ya(a,c,b){if(e[a.pendingNoteKey]){var d={name:"receiveClipResultInfo"};d.title=e[a.pendingNoteKey].filingInfo.title;d.type=e[a.pendingNoteKey].filingInfo.type;d.notebookGuid=e[a.pendingNoteKey].filingInfo.notebookGuid;d.notebookName=e[a.pendingNoteKey].filingInfo.notebookName;
d.linkedNotebookGuid=e[a.pendingNoteKey].filingInfo.linkedNotebookGuid;d.shareKey=e[a.pendingNoteKey].filingInfo.shareKey;d.tagNames=e[a.pendingNoteKey].filingInfo.tagNames;d.client=options.get("client");d.baseUrl=options.get("secureProto")+l.get("serviceHost");d.locale=l.getName();d.userId=k.getCurrentUser();d.url=e[a.pendingNoteKey].filingInfo.url;d.premium=k.getUserInfo().premium;d.updateGuid=e[a.pendingNoteKey].updateGuid;k.getAuthTokens(function(b){b&&("linked"==d.type&&(b.linked=e[a.pendingNoteKey].filingInfo.auth),
d.auth=b,Browser.sendToTab(c.tab||c.sender.tab,d))})}}function za(a,c,b){function d(b,d){if(b){var f=options.get("secureProto")+l.get("serviceHost")+"/shard/"+a.shardId+"/sh/"+a.guid+"/"+b;Browser.sendToTab(c.tab,{name:"doneSharing",guid:a.guid,noteSize:a.noteSize,savedAuthInfo:Persistent.get("savedAuthInfo"),shownNearQuotaUpsell:Persistent.get("shownNearQuotaUpsell"),source:a.source,token:a.auth,uploaded:Persistent.get("uploaded"),url:f});a.source?W({text:a.source}):W({text:f})}else w(d,c.tab)}var f;
f=new JsonRpc(null,["NoteStore.shareNote"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){f.client.NoteStore.shareNote(d,a.auth,a.guid)})}function w(a,c){(/PERMISSION_DENIED/.test(a.trace)||/AUTH_EXPIRED/.test(a.trace))&&/parameter:authenticationToken/.test(a.trace)?(V({authExpired:!0},{tab:c}),c&&Browser.sendToTab(c,{name:"tellUserToLogin"})):log.error(a.trace||a.message||a.stack||a)}var S="content/auth_tools/login.html",
P=!1,sa=!0,e={};L();var l,K,J;G=M=null;var Z=!1,k,C;window.addEventListener("offline",function(a){log.log("Went offline.")});window.addEventListener("online",function(a){log.log("Went online.");0<Object.keys(e)&&log.log("processing offline clips");for(var c in e)X(c,e[c].originatingTab)});var m={clipPage:"EN_safariContextClipPage",clipScreenshot:"EN_safariContextClipScreenshot",clipSelection:"EN_safariContextClipSelection",clipImage:"EN_safariContextClipImage",clipPDF:"EN_safariContextClipPDF",clipUrl:"EN_safariContextClipUrl"};
SAFARI&&(safari.application.addEventListener("contextmenu",wa,!1),safari.application.addEventListener("command",va,!1));Browser.addMessageHandlers({LOGOUT:V,main_isAuthenticated:oa,main_getTextResource:function(a,c,b){function d(a){f.readyState==f.DONE&&(e.responseText=200==f.status?f.responseText:null,Browser.sendToTab(c.tab,e))}var f,e={name:"content_textResource",href:null};a&&a.href&&(e.href=a.href,f=new XMLHttpRequest,f.open("GET",a.href),f.onreadystatechange=d,f.send());b&&b()},main_performNoteSearch:function(a,
c,b){function d(a,b){a.name="sameSiteNotes";Browser.sendToTab(c.tab,a)}function f(a){g=a;(n.bizAuthenticationToken&&r||!n.bizAuthenticationToken)&&d(z())}function e(a){r=a;g&&d(z())}function z(){for(var a=0;a<g.notes.list.length;a++)g.notes.list[a].shardId=q.shardId;if(n.bizAuthenticationToken){for(var a=g.notes.list.slice(0),c=0;c<r.notes.list.length;c++)r.notes.list[c].inBusinessNotebook=!0,r.notes.list[c].shardId=s.shardId,a.push(r.notes.list[c]);a.sort(function(a,c){return c.updated-a.updated});
a=a.slice(0,u);g.notesSize=Math.min(g.notesSize+r.notesSize,u);g.totalNotes+=r.totalNotes;g.notes.list=a}return g}function B(){q.client.NoteStoreExtra.findNotesWithSnippet(f,n.authenticationToken,A,0,u,h);n.bizAuthenticationToken&&s.client.NoteStoreExtra.findNotesWithSnippet(e,n.bizAuthenticationToken,A,0,u,h)}var h=a.resultSpec,A=a.noteFilter,n,q,s,g,r,u=10;a.maxNotes&&(u=a.maxNotes);k.isAuthenticated(function(a){if((n=a)&&n.authenticationToken){var c=options.get("secureProto")+l.get("serviceHost");
q=new JsonRpc(null,["NoteStoreExtra.findNotesWithSnippet"],c,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL"));q.initWithAuthToken(n.authenticationToken,function(){n.bizAuthenticationToken?(s=new JsonRpc(null,["NoteStoreExtra.findNotesWithSnippet"],c,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL")),s.initWithAuthToken(n.bizAuthenticationToken,B)):B()})}else d(null)});b&&b()},simSearch_getNotesRelatedToSearchQuery:function(a,c,b){Browser.sendToTab(c.tab,
{name:"getInfo",sendToTab:!0})},simSearch_receivePageInfo:function(a,c,b){function d(){var b;if("Google"!==a.info.searchEngine&&p.bizAuthenticationToken){var d=Math.max(3-s.length,2),f=[];b=[];for(var e=0;e<g.length&&!(f.length>=d&&b.length>=d);e++)g[e].inBusinessNotebook=!0,g[e].shardId=q.shardId,u[g[e].notebookGuid].joined?f.push(g[e]):(g[e].notebookName=u[g[e].notebookGuid].name,g[e].contact=g[e].attributes.lastEditedBy||g[e].attributes.author||u[g[e].notebookGuid].contact,b.push(g[e]));for(var e=
Math.min(d,f.length),e=Math.max(d-e,1),h=Math.min(e,b.length),d=f.slice(0,d-h),e=0;e<h;e++)d.push(b[e]);b=s.slice(0,3-d.length);for(e=0;e<d.length;e++)b.push(d[e]);0<r.length&&(b[Math.max(0,b.length-1)]=r[0]);b=0<b.length?b:null;Browser.sendToTab(c.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:b,type:"all",tokens:{pers:p.authenticationToken,biz:p.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(p.userId+"_noSimsearchResultsShown")})}else{if(p.bizAuthenticationToken){d=[];b=
[];for(f=0;f<g.length&&!(3<=d.length&&3<=b.length);)g[f].inBusinessNotebook=!0,g[f].shardId=q.shardId,u[g[f].notebookGuid].joined?d.push(g[f]):(g[f].notebookName=u[g[f].notebookGuid].name,g[f].contact=g[f].attributes.lastEditedBy||g[f].attributes.author||u[g[f].notebookGuid].contact,b.push(g[f])),f++;f=Math.max(3-d.length,1);f=Math.min(f,b.length);g=d.slice(0,3-f);for(d=0;d<f;d++)g.push(b[d]);0<r.length&&(g[Math.max(0,g.length-1)]=r[0]);b=[];0<s.length&&(b[0]=s);0<g.length&&(b[1]=g)}else b=0<s.length?
[s]:[];Browser.sendToTab(c.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:b[0],type:"account",isBizUser:Boolean(p.bizAuthenticationToken),tokens:{pers:p.authenticationToken,biz:p.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(p.userId+"_noSimsearchResultsShown")});p.bizAuthenticationToken&&Browser.sendToTab(c.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:b[1],type:"library",tokens:{pers:p.authenticationToken,biz:p.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(p.userId+
"_noSimsearchResultsShown")})}}function f(a,b){a?(s=a.relatedNotes?a.relatedNotes.list:[],(p.bizAuthenticationToken&&g&&r||!p.bizAuthenticationToken)&&d()):w(b,c.tab)}function e(a,b){if(a){if(a.relatedNotes){for(var f=0;f<a.containingNotebooks.list.length;f++){var h=a.containingNotebooks.list[f];u[h.guid]={joined:h.hasSharedNotebook,name:h.notebookDisplayName,contact:h.contactName}}g=a.relatedNotes.list}else g=[];s&&r&&d()}else w(b,c.tab)}function z(a,b){r=[];a?a.experts&&a.experts.list&&0<a.experts.list.length&&
r.push({title:a.experts.list[0].name,id:a.experts.list[0].id,type:"expert",role:a.experts.list[0].attributes?a.experts.list[0].attributes.title:null}):w(b,c.tab);s&&g&&d()}function B(){return{url:a.info.url,text:a.info.recommendationText,query:a.info.query,relatedNotesResultSpec:{includeTitle:!0,includeUpdated:!0,includeAttributes:!0,includeLargestResourceSize:!0,includeLargestResourceMime:!0,includeNotebookGuid:!0,includeUpdateSequenceNum:!0}}}function h(){JsonQueue.handleExpensiveOpRequest({shardId:n.shardId,
userId:p.userId,type:"pers"},n.client.NoteStoreExtra.getFilingRecommendations,f,p.authenticationToken,B())}function A(){JsonQueue.handleExpensiveOpRequest({shardId:q.shardId,userId:p.userId,type:"biz"},q.client.NoteStoreExtra.getFilingRecommendations,e,p.bizAuthenticationToken,B());q.client.NoteStore.findRelated(z,p.bizAuthenticationToken,{plainText:a.info.query},{maxExperts:1})}var n,q,s,g,r,u={},p,v;k.isAuthenticated(function(a){p=a;v=options.get("secureProto")+l.get("serviceHost");n=new JsonRpc(null,
["NoteStoreExtra.getFilingRecommendations","NoteStore.listLinkedNotebooks"],v,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL"));n.initWithAuthToken(p.authenticationToken,h);p.bizAuthenticationToken&&(q=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations","NoteStore.findRelated"],v,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL")),q.initWithAuthToken(p.bizAuthenticationToken,A))})},togglePDFContextMenuOption:function(a,c,b){SAFARI||
a.show==sa||((sa=a.show)?$():chrome.contextMenus.remove("pdf"))},getNotebooks:function(a,c,b){function d(){r.client.NoteStore.listNotebooks(f,a.authTokens.pers);r.client.NoteStore.listLinkedNotebooks(e,a.authTokens.pers)}function f(a,b){if(a){if(a.list&&0<a.list.length){for(var d=[],f={},e=0;e<a.list.length;e++)a.list[e].stack?(f[a.list[e].stack]||(f[a.list[e].stack]=[]),f[a.list[e].stack].push({defaultNotebook:a.list[e].defaultNotebook,guid:a.list[e].guid,name:a.list[e].name,stack:a.list[e].stack,
sharedToOthers:0<Math.max(a.list[e].sharedNotebooksSize,a.list[e].sharedNotebookIdsSize)||a.list[e].published})):d.push({class:"notebook",defaultNotebook:a.list[e].defaultNotebook,guid:a.list[e].guid,name:a.list[e].name,sharedToOthers:0<Math.max(a.list[e].sharedNotebooksSize,a.list[e].sharedNotebookIdsSize)||a.list[e].published});for(var g in f)d.push({class:"stack",name:g,notebooks:f[g]});Browser.sendToTab(c.tab,{name:"receivePersNotebooks",notebooks:d,recentNotebooks:Persistent.get("recentNotebooks")})}}else p==
k.getCurrentUser()&&w(b,c.tab)}function e(b,d){if(b){var f;a.authTokens.biz&&(f=k.getUserInfo(p).businessId);s=b.list.length;for(var y=0;y<b.list.length;y++){var v=b.list[y];f&&f==v.businessId?h[v.shareKey]={shareName:v.shareName,stack:v.stack}:A[v.shareKey]={shareName:v.shareName,stack:v.stack};q[v.shardId]||(q[v.shardId]=new JsonRpc(v.shardId,["NoteStore.authenticateToSharedNotebook","NoteStore.getSharedNotebookByAuth"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL")),
q[v.shardId].initWithAuthToken(a.authTokens.pers));var r=q[v.shardId];(function(){var b=v;if(b.shareKey)r.client.NoteStore.authenticateToSharedNotebook(function(a,c){a&&(a.linkedNotebookGuid=b.guid,a.shardId=b.shardId);z(a,c)},b.shareKey,a.authTokens.pers);else if(g++,s==g){for(var d in x)n.push({class:"stack",name:d,notebooks:x[d]});Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}})()}}else p==k.getCurrentUser()&&w(d,c.tab)}function z(a,
b){if(a){var d=q[a.shardId];m[a.authenticationToken]=setTimeout(function(){g++;if(s==g){for(var a in x)n.push({class:"stack",name:a,notebooks:x[a]});Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}},1E4);d.client.NoteStore.getSharedNotebookByAuth(function(c,b){c&&(c.authenticationToken=a.authenticationToken,c.username=a.user?a.user.username:a.publicUserInfo.username,c.linkedNotebookGuid=a.linkedNotebookGuid);clearTimeout(m[a.authenticationToken]);
B(c,b)},a.authenticationToken)}else if(p==k.getCurrentUser()&&(g++,w(b,c.tab),s==g)){for(d in x)n.push({class:"stack",name:d,notebooks:x[d]});Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}}function B(b,d){g++;b?b.notebookModifiable&&(h[b.shareKey]?(g--,u.client.NoteStore.getNotebook(function(a,d){a&&(a.name=h[b.shareKey].shareName,a.linkedNotebookGuid=b.linkedNotebookGuid,a.stack=h[b.shareKey].stack);g++;if(a){var f={guid:a.guid,
name:a.name,linkedNotebookGuid:a.linkedNotebookGuid,type:"biz"};a.contact.username!=v&&(f.bizUsername=a.contact.name);a.stack?(x[a.stack]||(x[a.stack]=[]),x[a.stack].push(f)):(f.class="notebook",n.push(f))}else p==k.getCurrentUser()&&w(d,c.tab);if(s==g){for(var e in x)n.push({class:"stack",name:e,notebooks:x[e]});Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}},a.authTokens.biz,b.notebookGuid)):A[b.shareKey]?A[b.shareKey].stack?
(x[A[b.shareKey].stack]||(x[A[b.shareKey].stack]=[]),x[A[b.shareKey].stack].push({auth:b.authenticationToken,guid:b.notebookGuid,name:A[b.shareKey].shareName,linkedUsername:b.username,linkedNotebookGuid:b.linkedNotebookGuid,shareKey:b.shareKey,type:"linked"})):n.push({class:"notebook",auth:b.authenticationToken,guid:b.notebookGuid,name:A[b.shareKey].shareName,linkedUsername:b.username,linkedNotebookGuid:b.linkedNotebookGuid,shareKey:b.shareKey,stack:A[b.shareKey].stack,type:"linked"}):log.warn("received unknown shared notebook"+
JSON.stringify(b))):p==k.getCurrentUser()&&w(d,c.tab);if(s==g){for(var f in x)n.push({class:"stack",name:f,notebooks:x[f]});Browser.sendToTab(c.tab,{name:"receiveSharedNotebooks",notebooks:n,recentNotebooks:Persistent.get("recentNotebooks")})}}var h={},A={},n=[],q={},s=0,g=0,r,u,p=a.userId,v=a.username,x={},m={};(function(){r=new JsonRpc(null,["NoteStore.listNotebooks","NoteStore.listLinkedNotebooks"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL"));r.initWithAuthToken(a.authTokens.pers,
function(){a.authTokens.biz?(u=new JsonRpc(null,["NoteStore.getNotebook"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL")),u.initWithAuthToken(a.authTokens.biz,d)):d()})})()},getTags:function(a,c,b){function d(){z.client.NoteStore.listTags(e,a.authTokens.pers);a.authTokens.biz&&B.client.NoteStore.listTags(f,a.authTokens.biz)}function f(a,b){if(a){if(a.list&&0<a.list.length){for(var d=[],f=0;f<a.list.length;f++)d.push(a.list[f].name);Browser.sendToTab(c.tab,{name:"receiveBizTags",
tags:d})}}else h==k.getCurrentUser()&&w(b,c.tab)}function e(a,b){if(a){if(a.list&&0<a.list.length){for(var d=[],f=0;f<a.list.length;f++)d.push(a.list[f].name);Browser.sendToTab(c.tab,{name:"receivePersTags",tags:d})}}else h==k.getCurrentUser()&&w(b,c.tab)}var z,B,h=a.userId;(function(){z=new JsonRpc(null,["NoteStore.listTags"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL"));z.initWithAuthToken(a.authTokens.pers,function(){a.authTokens.biz?(B=new JsonRpc(null,
["NoteStore.listTags"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL")),B.initWithAuthToken(a.authTokens.biz,d)):d()})})()},getSmartFilingInfo:function(a,c,b){function d(){var c;n&&(c=JSON.parse(JSON.stringify(n)));var b;q&&(b=JSON.parse(JSON.stringify(q)));var d={},f;f=la(c&&c.relatedNotes?c.relatedNotes.list:[],s.shardId,b&&b.relatedNotes?b.relatedNotes.list:[],g?g.shardId:null,m);0<f.length&&(d.relatedNotes={list:f});"smartFiling"==options.get("notebookSelection")&&
(c&&c.notebook&&(d.notebook=c.notebook),a.authTokens.biz&&options.get("bizSmartFilingEnabled")&&b&&b.notebook&&!b.notebook.restrictions.noCreateNotes&&(d.notebook=b.notebook,d.notebook.biz=!0));options.get("smartFilingTags")&&(c&&c.tags&&(d.tags=c.tags),a.authTokens.biz&&b&&b.tags&&d.notebook&&d.notebook.biz&&(d.tags=b.tags));return d}function f(){s=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL"));
s.initWithAuthToken(a.authTokens.pers,function(){a.authTokens.biz?(g=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL")),g.initWithAuthToken(a.authTokens.biz,function(){e()})):e()})}function e(){var b={query:a.query,relatedNotesResultSpec:p,text:a.recText,url:c.tab.url};JsonQueue.handleExpensiveOpRequest({shardId:s.shardId,userId:h,type:"pers"},s.client.NoteStoreExtra.getFilingRecommendations,B,a.authTokens.pers,
b);a.authTokens.biz&&(b.relatedNotesResultSpec.maxResults=10,JsonQueue.handleExpensiveOpRequest({shardId:g.shardId,userId:h,type:"biz"},g.client.NoteStoreExtra.getFilingRecommendations,z,a.authTokens.biz,b))}function z(a,b){u=!0;if(a){if(a.relatedNotes){m={};for(var f=0;f<a.containingNotebooks.list.length;f++){var e=a.containingNotebooks.list[f];m[e.guid]={joined:e.hasSharedNotebook,name:e.notebookDisplayName,contact:e.contactName}}}q=a}else h==k.getCurrentUser()&&w(b,c.tab);r&&Browser.sendToTab(c.tab,
{name:"receiveSmartFilingInfo",filingInfo:d()})}function B(b,f){r=!0;b?n=b:h==k.getCurrentUser()&&w(f,c.tab);(a.authTokens.biz&&u||!a.authTokens.biz)&&Browser.sendToTab(c.tab,{name:"receiveSmartFilingInfo",filingInfo:d()})}var h=a.userId,m,n,q,s,g,r,u,p={includeAttributes:!0,includeLargestResourceMime:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0};a.recText?f():log.warn("no recommendation text")},getKeyboardShortcuts:function(a,c,b){if(c&&c.tab){b={};for(var d=0;d<a.shortcuts.length;d++)b[a.shortcuts[d]]=
options.get(a.shortcuts[d]);Browser.sendToTab(c.tab,{name:"receiveKeyboardShortcuts",keys:b,keyboardShortcutsEnabled:options.get("enableKeyboardShortcuts")})}},main_setOption:function(a,c,b){for(var d in a.options)options.set(d,a.options[d]);b&&b()},main_getConfig:function(a,c,b){if(c&&c.tab){var d={name:"config"};a.returnName&&(d.name=a.returnName);if(a.options){d.options={};for(var f in a.options)d.options[f]=options.get(f)}if(a.bootstrapInfo)for(f in d.bootstrapInfo={},a.bootstrapInfo)l&&(d.bootstrapInfo[f]=
l.get(f));Browser.sendToTab(c.tab,d);b&&b(d)}},main_openTab:pa,main_openWindow:qa,main_restart:na,main_recordActivity:ra,main_getL10n:function(a,c,b){Browser.sendToTab(c.tab,{name:"l10nData",data:Browser.i18n._getL10nData()});b&&b()},bounce:function(a,c,b){c.tab&&Browser.sendToTab(c.tab,a.message)},bounceToAll:function(a,c,b){Browser.getAllTabs(function(c){for(var b=0;b<c.length;b++)Browser.sendToTab(c[b],a.message)})},insertCSS:function(a,c,b){Browser.insertCSS(a.filename)},getPersistentFlag:function(a,
c,b){Browser.sendToTab(c.tab,{name:"receivePersistentFlag",key:a.key,value:Persistent.get(a.key)});a.set&&Persistent.set(a.key,a.setValue)},captureScreenshot:function(a,c,b){setTimeout(function(){a.contextMenu?Browser.captureVisibleTab(a,c,function(a){k.isAuthenticated(function(b){if(b){var e=UUID.generateGuid();Browser.sendToTab(c.tab,{name:"showClipResult",pendingNoteKey:e,userId:b.userId,userType:t(b)});for(var k=atob(a.split(",")[1]),l=new Uint8Array(k.length),h=0;h<k.length;h++)l[h]=k.charCodeAt(h);
I({clipType:"skitch",content:'<img src="resource:0"></img>',contentClass:"evernote.skitch",pendingNoteKey:e,resources:[{bytes:l,mime:"image/png"}],userId:b.userId,userType:t(b)},c);Browser.sendToTab(c.tab,{name:"finishContextMenuScreenshot"})}else log.error("logged out while taking screenshot from context menu")})}):Browser.captureVisibleTab(a,c)},300)},prepareScreenshot:ga,copyText:W,getOption:function(a,c,b){a.name="receiveOption";"defaultClipAction"==a.option?(a.key="clipAction","lastUsed"==options.get("defaultClipAction")?
(b=Persistent.get("lastUsedAction"),a.value=b?b:"ARTICLE"):a.value=options.get("clipAction")):(a.key=a.option,a.value=options.get(a.key));delete a.option;Browser.sendToTab(c.tab,a)},receiveNoteContent:I,receiveNoteFilingInfo:H,getRelatedNotes:function(a,c,b){function d(){Browser.sendToTab(c.tab,{name:"relatedNotes",relatedNotes:la(m?m:[],n.shardId,h?h:[],q?q.shardId:null,t)})}function f(){var b={relatedNotesResultSpec:{includeAttributes:!0,includeLargestResourceMime:!0,includeNotebookGuid:!0,includeTitle:!0,
includeUpdated:!0},text:e[a.pendingNoteKey].recommendationText,url:c.tab.url};JsonQueue.handleExpensiveOpRequest({shardId:n.shardId,userId:a.userId,type:"pers"},n.client.NoteStoreExtra.getFilingRecommendations,z,a.tokens.authenticationToken,b);a.tokens.bizAuthenticationToken&&JsonQueue.handleExpensiveOpRequest({shardId:q.shardId,userId:a.userId,type:"biz"},q.client.NoteStoreExtra.getFilingRecommendations,k,a.tokens.bizAuthenticationToken,b)}function k(a,b){if(a)if(a.relatedNotes&&a.relatedNotes.list){h=
a.relatedNotes.list;for(var f=0;f<a.containingNotebooks.list.length;f++){var e=a.containingNotebooks.list[f];t[e.guid]={joined:e.hasSharedNotebook,name:e.notebookDisplayName,contact:e.contactName}}}else h=[];else h=[],w(b,c.tab);m&&d()}function z(b,f){b?m=b.relatedNotes&&b.relatedNotes.list?b.relatedNotes.list:[]:(m=[],w(f,c.tab));(!a.tokens.bizAuthenticationToken||a.tokens.bizAuthenticationToken&&h)&&d()}var m,h,t={},n,q;e[a.pendingNoteKey]&&(e[a.pendingNoteKey].relatedNotes?Browser.sendToTab(c.tab,
{name:"relatedNotes",relatedNotes:e[a.pendingNoteKey].relatedNotes}):(n=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL")),n.initWithAuthToken(a.tokens.authenticationToken,function(){a.tokens.bizAuthenticationToken?(q=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL")),q.initWithAuthToken(a.tokens.bizAuthenticationToken,
f)):f()})))},toggleClipper:F,trackEvent:function(a,c,b){Analytics.trackEvent(a.userId,a.category,a.action,a.label,a.value)},emailNote:function(a,c,b){function d(b,d){Browser.sendToTab(c.tab,{name:"emailResult",numEmailed:a.recipients.length,error:d});d&&w(d,c.tab)}var f;f=new JsonRpc(null,["NoteStore.emailNote","NoteStoreExtra.emailNotesSharedWorkaround"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){a.sharedAuth?f.client.NoteStoreExtra.emailNotesSharedWorkaround(d,
a.sharedAuth,a.persAuth,{javaClass:"java.util.ArrayList",list:a.recipients},{javaClass:"java.util.ArrayList",list:[a.noteGuid]},a.message):f.client.NoteStore.emailNote(d,a.auth,{guid:a.noteGuid,toAddresses:{javaClass:"java.util.ArrayList",list:a.recipients},message:a.message})})},findContacts:function(a,c,b){function d(a,b){a&&a.list?Browser.sendToTab(c.tab,{name:"receiveContacts",contacts:a.list}):w(b,c.tab)}var f;f=new JsonRpc(null,["NoteStore.findContacts"],null,options.get("secureProto"),l.get("serviceHost"),
options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){f.client.NoteStore.findContacts(d,a.auth,{maxEntries:5,prefix:a.prefix})})},showOpenState:function(){Browser.setIcon("images/close-ext")},showLoggedInState:U,showLoggedInOrOutState:N,setReminder:function(a,c,b){function d(a,b){b&&w(b,c.tab)}var f;f=new JsonRpc(null,["NoteStore.updateNote"],null,options.get("secureProto"),l.get("serviceHost"),options.get("overrideServiceURL"));f.initWithAuthToken(a.auth,function(){var c={source:"web.clip",
sourceURL:a.sourceURL,reminderOrder:a.reminderOrder};a.reminderTime&&(c.reminderTime=a.reminderTime);f.client.NoteStore.updateNote(d,a.auth,{guid:a.noteGuid,title:a.title,attributes:c})})},clipResultShown:function(a,c,b){H({noteFilingInfo:{title:c.tab.title||Browser.i18n.getMessage("quickNote_untitledNote"),type:"pers",url:c.tab.url},pendingNoteKey:a.pendingNoteKey,userId:a.userId,userType:a.userType},c)},getPersistentValue:function(a,c,b){c&&c.tab&&Browser.sendToTab(c.tab,{name:"receivePersistentValue",
key:a.key,value:Persistent.get(a.key)})},setPersistentValue:function(a,c,b){Persistent.set(a.key,a.value)},downloadThumbnail:function(a,c,b){b=new XMLHttpRequest;b.guid=a.guid;b.open("POST",a.url,!0);b.responseType="arraybuffer";b.onreadystatechange=function(){if(200==this.status&&4==this.readyState){for(var a="",b=new Uint8Array(this.response),e=0;e<b.length;e++)a+=String.fromCharCode(b[e]);Browser.sendToTab(c.tab,{name:"receiveThumbnail",guid:this.guid,datauri:"data:"+this.getResponseHeader("Content-type")+
";base64,"+btoa(a)})}};a.biz?a.size?b.send("auth="+a.tokens.biz+"&size="+a.size):b.send("auth="+a.tokens.biz):b.send("auth="+a.tokens.pers+"&size="+a.size)},cropImage:function(a,c,b){var d=new Image;d.onload=function(){var b=document.createElement("canvas");b.width=Math.min(150,a.width);b.height=Math.min(150,a.height);b.getContext("2d").drawImage(d,Math.max(0,(a.width-150)/2),Math.max(0,(a.height-150)/2),b.width,b.height,0,0,b.width,b.height);Browser.sendToTab(c.tab,{name:"receiveCroppedImage",datauri:b.toDataURL(),
url:a.url})};d.src=a.url},tourLoaded:function(a,c,b){K=c.tab.id;J=c.tab.url;a=c.tab;Browser.sendToTab(a,{name:"toggleCoordinator",baseUrl:options.get("secureProto")+l.get("serviceHost"),userId:"fake",username:Browser.i18n.getMessage("fleFakeUser"),authTokens:{},premium:!1,fullName:Browser.i18n.getMessage("fleFakeUser"),dontStartPreview:!0});Browser.sendToTab(a,{name:"startTour"});b&&b()},finishTour:function(a,c,b){J=K=null},isTouring:function(a,c,b){a=ia(c.tab);Browser.sendToTab(c.tab,{name:"isTouring",
data:a});b&&b()},loadXMLHttpRequest:function(a,c,b){var d=new XMLHttpRequest;d.onreadystatechange=function(){4===d.readyState&&Browser.sendToTab(c.tab,{name:"receiveXMLHttpRequest",response:d.responseText})};d.open("GET",a.url);d.send()},tabLoaded:function(a,c,b){c&&c.tab&&(a=c.tab,console.log("Autorun"),a.id===M&&G&&(c=G,M=G=null,console.log("Executed"),c(a)))},sendAppFeedback:function(a,c,b){k.isAuthenticated(function(b){if(b){var f=options.get("secureProto")+l.get("serviceHost"),f=new Thrift.BinaryHttpTransport(f+
"/shard/"+b.shardId+"/utility"),f=new Thrift.BinaryProtocol(f),f=new UtilityClient(f),e=new AppFeedback,m=new SupportTicket;m.applicationVersion=Browser.EVERNOTE_VERSION;m.contactEmail=k.getUserInfo(b.userId).email;m.osInfo=a.os;m.deviceInfo=a.browser;m.subject=a.title;m.issueDescription="User agent: "+navigator.userAgent+"\nLanguage: "+navigator.language+"\nFiled from: "+c.tab.url+"\n\n"+a.details;e.rating=a.rating;e.feedback=m;f.sendAppFeedback(b.authenticationToken,e,function(a){console.log(a)},
function(a){log.error("problem sending app feedback: Error code "+a.errorCode+"\n"+a)})}else log.error("logged out while filing a support ticket")})}});this.setOption=function(a,c){options.set(a,c)};this.getOption=function(a){return options.get(a)};this.getBootstrapInfo=ja;this.getBootstrapInfoLength=ha;this.start=function(){(new Bootstrapper(options.get("simulateSimplifiedChinese"),options.get("useStage"),options.get("overrideServiceURL"),options.get("secureProto"))).bootstrap(Y)};this.startUp=Y;
this.bootstrap=function(a){(new Bootstrapper(options.get("simulateSimplifiedChinese"),options.get("useStage"),options.get("overrideServiceURL"),options.get("secureProto"))).bootstrap(function(){try{l=new BootstrapInfo(options.get("overrideServiceURL")),a&&a()}catch(c){log.error(c)}})};this.showLoggedInState=U;this.showLoggedOutState=ma;this.setBadge=L;this.msgHandlerIsAuthenticated=oa;this.msgHandlerLogin=function(a,c,b){k.login(a.username,a.password,function(a){a.error||(a.bizAuthenticationToken&&
!Persistent.get(a.userId+"_turnedOffSearchHelper")&&options.set("useSearchHelper",!0),a.username&&(Browser.setBrowserActionClickHandler(function(a){F(null,{tab:a})}),Browser.setPopup("")));Browser.getCurrentTab(function(c){a.currentTab=c;b(a)})})};this.msgHandlerSubmitTwoStepCode=function(a,c,b){k.completeTwoFactorAuthentication(a.auth,a.code,function(a){a.error||(Browser.setBrowserActionClickHandler(function(a){F(null,{tab:a})}),Browser.setPopup(""));Browser.getCurrentTab(function(c){a.currentTab=
c;b(a)})})};this.msgHandlerGetRegistrationLinks=function(a,c,b){a="clipper_chr";SAFARI?a="clipper_saf":OPERA?a="clipper_op":YANDEX&&(a="clipper_yan");c=new FormData;c.append("code",a);var d=new XMLHttpRequest;d.open("POST",options.get("secureProto")+l.get("serviceHost")+"/CreateUserJSON.action?",!0);d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){var a=JSON.parse(d.response);b({captcha:a.captcha,submit:a.submit})}else 0==d.status?(log.error("couldn't get registration form links because of network error"),
b({error:"NETWORK"})):4==d.readyState&&log.error("couldn't get registration form links because of error: "+d.status)};d.send(c)};this.switchService=function(a,c,b){1<l.getLength()&&(a=l.getIndex(),l.setIndex((a+1)%2),b())};this.msgHandlerLogout=V;this.msgHandlerOpenTab=pa;this.msgHandlerOpenWindow=qa;this.msgHandlerRestart=na;this.msgHandlerRecordActivity=ra;this.toggleClipper=F;Object.preventExtensions(this)}Object.preventExtensions(Extension);var extension=new Extension;extension.start();
