function ContentPreview(){function y(){g.parentNode||document.documentElement.appendChild(g);var a=window.getComputedStyle(g,""),c=parseInt(a.getPropertyValue("width")),a=parseInt(a.getPropertyValue("height"));c&&a&&(g.style.marginLeft=0-c/2+"px",g.style.marginTop=0-a/2+"px")}function z(a,c,b,d,f){var l={"http://localhost/favicon.ico":!0},h,k;a=GlobalUtils.createTitleAndLinkPortionOfUrlClipContent(a,c);var e=a.content,g=a.textPortion,m=a.link,r=a.url,p=document.createElement("div"),n=document.createElement("img"),
q=document.createElement("img");a=document.createElement("div");""!=d.trim()&&(a.textContent=500>d.length?d:d.slice(0,500)+"...",a.style.fontFamily="Helvetica, Arial, sans-serif",a.style.fontSize="12px",a.style.color="#0C0C0C",a.style.display="block",a.style.whiteSpace="normal",a.style.marginTop="15px",a.style.maxHeight="154px",a.style.overflow="hidden",g.appendChild(a));pageInfo.getBiggestImage(function(a){h=!0;a.src&&(p.style.position="relative",p.style.display="inline-block",p.style.width="150px",
p.style.height="150px",p.style.margin="15px 30px 0px 0px",p.style.overflow="hidden",150<a.height||150<a.width?(n.setAttribute("thumbnail",a.src),w=n,Browser.sendToExtension({name:"cropImage",height:a.height,url:a.src,width:a.width}),n.style.maxWidth="none",n.style.maxHeight="none"):n.src=a.src,n.width=Math.min(150,a.width),n.height=Math.min(150,a.height),p.appendChild(n),g.parentNode?e.insertBefore(p,g):e.appendChild(p));k&&f(e)});if(b&&!l[b.toLowerCase()])q.onload=function(){k=!0;q.style.display=
"inline-block";q.style.border="none";q.style.width="16px";q.style.height="16px";q.style.padding="0px";q.style.margin="0px 8px -2px 0px";q.width="16";q.height="16";m.insertBefore(q,r);h&&f(e)},q.onerror=function(){k=!0;h&&f(e)},q.src=b;else if(k=!0,h)return e}function s(){k.reset();k.hide();g.parentNode&&g.parentNode.removeChild(g);t.parentNode&&t.parentNode.removeChild(t)}function A(){if(e){var a;void 0!==typeof pageInfo&&(a=pageInfo.getSelectionFrame());a?(k.revealStaticRect(k.expandRect({width:a.width,
height:a.height,top:a.offsetTop,bottom:a.height+a.offsetTop,left:a.offsetLeft,right:a.width+a.offsetLeft},-9),a,!0),k.show()):k.outlineElement(e,!0,!0)}else log.warn("Couldn't find a preview element. We should switch to 'full page' mode.")}function u(a,c){if(!a)return log.warn("Can't determine if 'null' is interesting (it's probably not)."),!1;if(a===window.document||""==a.textContent.trim()&&0===a.getElementsByTagName("img").length)return!1;var b=a.getBoundingClientRect();if(!b.width||!b.height)return!1;
b=getComputedStyle(a);return"hidden"===b.visibility||"none"===b.display||a.parentNode&&c.parentNode&&(a.parentNode==c||c.parentNode==a)&&B(a,c)?!1:!0}function B(a,c){var b=a.getBoundingClientRect(),d=c.getBoundingClientRect();if(b.bottom==d.bottom&&b.height==d.height&&b.left==d.left&&b.right==d.right&&b.top==d.top&&b.width==d.width||a.textContent===c.textContent&&a.getElementsByTagName("img").length===c.getElementsByTagName("img").length)return!1}function C(a){for(var c=0;c<a.children.length;c++){if(B(a.children[c],
a))return C(a.children[c]);if(u(a.children[c],a))return a.children[c]}return a}function D(a){a.className+=" evernoteEmailSelectedMessage";a=a.children[1].firstElementChild;a.className=a.className.replace(/\s*evernoteEmailDimmed/g,"");document.querySelectorAll(".evernoteEmail").length===document.querySelectorAll(".evernoteEmail.evernoteEmailSelectedMessage").length&&(document.querySelector("#evernoteEmailSelectAllMessages").className+=" evernoteEmailSelectedMessage")}function E(a){a.className=a.className.replace(/\s*evernoteEmailSelectedMessage/g,
"");a.children[1].firstElementChild.className+=" evernoteEmailDimmed";a=document.querySelector("#evernoteEmailSelectAllMessages");a.className=a.className.replace(/\s*evernoteEmailSelectedMessage/g,"")}function J(){var a=document.createElement("style");a.title="evernoteGmailSafariCSS";document.head||(document.head=document.createElement("head"));document.head.appendChild(a);for(var c,b=0;b<document.styleSheets.length;b++)if(document.styleSheets[b].title==a.title){c=document.styleSheets[b];break}for(var a=
"#evernoteEmailPreview .evernoteEmailHeader, #evernoteEmailPreview .evernoteEmailDimmed, #evernoteEmailPreview .evernoteEmailAttachments;#evernoteEmailPreview .evernoteEmailHeader;#evernoteEmailPreview .evernoteEmailBig;#evernoteEmailPreview .evernoteEmailMedium;#evernoteEmailPreview .evernoteEmailSmall;#evernoteEmailPreview .evernoteEmailRight;#evernoteEmailPreview .evernoteEmailDimmed;#evernoteEmailPreview .evernoteEmailDivider;#evernoteEmailPreview .evernoteEmailLight;#evernoteEmailPreview .evernoteEmailDark;#evernoteEmailPreview .evernoteEmailLong;#evernoteEmailPreview .evernoteEmailShort;#evernoteEmailParticipants;#evernoteEmailLinkBack;#evernoteEmailLinkBackArrow;#evernoteEmailPreview .evernoteEmail;#evernoteEmailPreview .evernoteEmailBody;#evernoteEmailPreview .evernoteEmailAttachments;#evernoteEmailPreview .evernoteEmailAttachments .evernoteEmailSize".split(";"),
d="font-family: Helvetica, Arial, sans-serif !important;{color: #333333 !important; font-weight: bold !important;{font-size: 15px !important;{font-size: 14px !important;{font-size: 12px !important;{float: right !important;{color: #888888 !important;{height: 1px !important;{background-color: #E9E9E9 !important;{background-color: #B3B3B3 !important;{left: -48px !important; position: relative !important; width: -webkit-calc(100% + 96px) !important;{width: 100% !important;{margin: 16px 0 29px 0 !important;{display: block; margin: 22px 0 8px 0 !important; position: relative !important; text-decoration: none !important;{background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAALCAYAAAB24g05AAAAr0lEQVQoU2NkwAKMjY35gcLTzp49G41NHlmMEV2BgYGBNRMT0xJGRkYFoAEY8ujqkRWwGBoa1gI1VwMVMYMUEm2Arq6uEisr62KgrVbINhBlgJGRUQxQ41SgRj5C/sUmzwh0dhzQ2ZPJNgBkKtQLS4EusSDWC8CY+g9SixKIQME6oFgVMYGIzQCw5UAJm////4OiUR5fIOI0AGoIP9CQGefOnYvEFbB4DSAmNmAGAABi7TE0OfL+0wAAAABJRU5ErkJggg==) !important;background-repeat: no-repeat !important; background-size: 16px 11px !important;display: inline-block; height: 11px !important; margin-right: 12px; width: 16px !important;{margin: 24px 0 !important; position: relative !important;{color: #222; font-family: Arial, sans-serif; font-size: 13px; margin-top: 24px !important;{padding: 20px 0 0 40px !important;{margin-left: 10px !important;".split("{"),
b=0;b<a.length;b++)c.addRule(a[b],d[b])}function F(a,c){var b={top:Math.min(a.top,c.top),bottom:Math.max(a.bottom,c.bottom),left:Math.min(a.left,c.left),right:Math.max(a.right,c.right)};b.width=b.right-b.left;b.height=b.bottom-b.top;return b}function K(a){if(0!==a.endOffset||a.endContainer.nodeType!==Node.ELEMENT_NODE)return a=a.getBoundingClientRect(),{top:a.top,bottom:a.bottom,left:a.left,right:a.right,width:a.width,height:a.height};var c=null;try{c=a.endContainer.getBoundingClientRect()}catch(b){log.warn("Couldn't get a bounding client rect for our end element, maybe it's a text node.")}for(var d=
!1,f=[],l=a.getClientRects(),h=0;h<l.length;h++)(c||l[h]?c&&l[h]&&c.top==l[h].top&&c.bottom==l[h].bottom&&c.left==l[h].left&&c.right==l[h].right&&c.width==l[h].width&&c.height==l[h].height:1)&&!d?d=!0:f.push(l[h]);if(0==f.length)return a.getBoundingClientRect();if(1==f.length)return f[0];a=f[0];for(h=1;h<f.length;h++)a=F(a,f[h]);return a}function G(a,c){var b=c,d=a.getBoundingClientRect(),d={bottom:d.bottom+window.scrollY,height:d.height,left:d.left+window.scrollX,right:d.right+window.scrollX,top:d.top+
window.scrollY,width:d.width};if("rtl"==document.dir||0>d.bottom&&0>d.top||0>d.left&&0>d.right)return b;var f=getComputedStyle(a);if("none"==f.display||"hidden"==f.overflowX||"hidden"==f.overflowY)return b;1<d.width*d.height&&(b=F(d,c));if(a.children)for(d=0;d<a.children.length;d++)b=G(a.children[d],b);return b}function H(){var a;if(void 0!==typeof pageInfo&&!m){a=pageInfo.getSelection();m=[];r=[];for(var c=0;c<a.rangeCount;c++)m.push(a.getRangeAt(c).cloneRange()),r.push([m[c].startOffset,m[c].endOffset]);
v=pageInfo.getSelectionFrame()}if(!a){a=window.getSelection();a.removeAllRanges();for(var b=0;b<m.length;b++){var d=document.createRange();if((m[b].startContainer.length||m[b].startContainer.children.length)<r[b][0])for(var f=0,c=0;c<m[b].startContainer.childNodes.length;c++){var l=m[b].startContainer.childNodes[c],h=0,h=l.getAttribute&&l.getAttribute("clearly_highlight_id")?(l.innerText||l.textContent).length:l.length||l.children.length,f=f+h;if(f>=r[b][0]){d.setStart(l,r[b][0]-(f-h));break}}else d.setStart(m[b].startContainer,
r[b][0]);if((m[b].endContainer.length||m[b].endContainer.children.length)<r[b][1])for(c=f=0;c<m[b].endContainer.childNodes.length;c++){if(l=m[b].endContainer.childNodes[c],h=l.getAttribute&&l.getAttribute("clearly_highlight_id")?(l.innerText||l.textContent).length:l.length||l.children.length,f+=h,f>=r[b][1]){d.setEnd(l,r[b][1]-(f-h));break}}else d.setEnd(m[b].endContainer,r[b][1]);a.addRange(d)}}return a}function I(){var a=H();k.reset();var c=null;v&&(c=v.getBoundingClientRect());var b,d;if(a)for(s(),
k.reset(),d=0;d<a.rangeCount;d++)b=a.getRangeAt(d),b=K(b),b.top+=document.body.scrollTop,b.bottom+=document.body.scrollTop,b.left+=document.body.scrollLeft,b.right+=document.body.scrollLeft,c&&(b.left+=c.left,b.right+=c.left,b.top+=c.top,b.bottom+=c.top),k.revealStaticRect(b,v,!1),k.show();k.show()}var k=new ContentVeil,L=new GmailClipper;SAFARI&&J();var e=null,x=0,m=null,r=null,v=null,g=function(){var a=document.createElement("div");a.id="evernotePreviewContainer";a.className="evernotePreviewContainer evernotePreviewUrlContainer";
return a}(),w,t=function(){var a=document.createElement("div");a.id="evernoteEmailPreview";return a}();Browser.addMessageHandlers({receiveCroppedImage:function(a,c,b){w&&(w.src=a.datauri,w.removeAttribute("thumbnail"))}});window.addEventListener("message",function(a){RegExp(a.origin,"i").test(Browser.extension.getURL(""))&&"clearPreview"==a.data.name&&s()});this.clear=s;this.getArticleElement=function(){return e};this.getUrlElement=function(a){function c(){var a=g.querySelector("[thumbnail]");a&&
a.parentNode.parentNode.removeChild(a.parentNode);for(var a="",c=g.innerHTML.split(/(?=<img.[^>]+>)/),f=0;f<c.length;f++)a=/^<img/.test(c[f])?a+c[f].replace(/>/,"></img>"):a+c[f];return a}if(g.innerHTML)return c();pageInfo.getRecommendationText(!0,function(b){if(b=z(document.title,document.location.href,pageInfo.favIconUrl,b,function(b){b&&(g.innerHTML="",g.appendChild(b),a(c()))}))g.innerHTML="",g.appendChild(b),a(c())})};this.looksInteresting=u;this.computeDescendantBoundingBox=function(a){if(!a)return{top:0,
bottom:0,left:0,right:0,width:0,height:0};var c=a.getBoundingClientRect();return G(a,{bottom:c.bottom+window.scrollY,height:c.height,left:c.left+window.scrollX,right:c.right+window.scrollX,top:c.top+window.scrollY,width:c.width})};this.getEmailElement=function(){if(t){for(var a=t.firstElementChild,c=a.querySelectorAll(".evernoteEmailCheckbox, #evernoteEmailSelectAllMessages, .evernoteEmail:not(.evernoteEmailSelectedMessage)"),b=0;b<c.length;b++)if(c.item(b).parentNode){if(c.item(b).webkitMatchesSelector(".evernoteEmail")){var d=
c.item(b).previousElementSibling;d&&/evernoteEmailDivider/.test(d.className)&&/evernoteEmailShort/.test(d.className)||(d=c.item(b).nextElementSibling);d&&d.parentNode&&/evernoteEmailDivider/.test(d.className)&&/evernoteEmailShort/.test(d.className)&&d.parentNode.removeChild(d)}if("evernoteEmailSelectAllMessages"==c.item(b).id){d=document.createElement("a");d.id="evernoteEmailLinkBack";d.className="evernoteEmailHeader evernoteEmailMedium";d.target="_blank";d.href=document.location.href;var f=document.createElement("div");
f.id="evernoteEmailLinkBackArrow";d.appendChild(f);f=document.createElement("span");f.innerText=Browser.i18n.getMessage("openConvoInGmail");d.appendChild(f);c.item(b).parentNode.insertBefore(d,c.item(b))}c.item(b).parentNode.removeChild(c.item(b))}if(c=a.querySelector(".evernoteEmailDivider.evernoteEmailLong"))c.className=c.className.replace(/\s*evernoteEmailLong/g," evernoteEmailShort");return a}return null};this.previewArticle=function(a,c,b){window.focus();s();e||void 0===typeof pageInfo?e?(A(),
1<x&&k.setPageCount(x-1)):log.warn("Couldn't find a 'pageInfo' object."):e=pageInfo.getDefaultArticle(function(a){e=a;A()},function(a,c,b){x=b;1<b&&x&&k.setPageCount(b-1)})};this.previewFullPage=function(){var a=document.body.scrollWidth,c=document.body.scrollHeight,a={bottom:c-4,top:4,left:4,right:a-4,width:a-8,height:c-8};s();k.reset();k.revealStaticRect(a,document.body);k.show()};this.previewSelection=I;this.ensureSelectionIsShown=H;this.previewUrl=function(a,c,b){function d(a){g.innerHTML="";
g.appendChild(a);y()}var f=document.title,e=document.location.href,h=pageInfo.favIconUrl;s();k.gray();pageInfo.getRecommendationText(!0,function(a){if(a=z(f,e,h,a,d))g.innerHTML="",g.appendChild(a),y()})};this.previewEmail=function(){var a=document.querySelector("#evernoteTooltip");a&&a.parentNode.removeChild(a);s();k.reset();k.gray();t.innerHTML="";var c=document.createElement("div");c.id="evernoteEmailLoading";t.appendChild(c);t.parentNode||document.documentElement.appendChild(t);var b=document.createElement("div"),
d=document.createElement("div");d.className="evernoteEmailHeader evernoteEmailBig";b.appendChild(d);var f=document.createElement("div");f.id="evernoteEmailParticipants";f.className="evernoteEmailHeader evernoteEmailSmall";b.appendChild(f);var e=document.createElement("div");e.className="evernoteEmailDivider evernoteEmailLight evernoteEmailLong";b.appendChild(e);a=document.createElement("div");a.id="evernoteEmailSelectAllMessages";a.className="evernoteEmailHeader evernoteEmailMedium evernoteEmailSelectedMessage";
var h=document.createElement("div");h.className="evernoteEmailCheckbox";h.addEventListener("click",function(){var a=document.querySelectorAll(".evernoteEmail");if(/evernoteEmailSelectedMessage/.test(this.parentNode.className))for(var b=0;b<a.length;b++)E(a.item(b));else for(b=0;b<a.length;b++)D(a.item(b))});a.appendChild(h);var g=document.createElement("span");g.innerText=Browser.i18n.getMessage("selectAllMessages");a.appendChild(g);b.appendChild(a);L.getThread(function(a,k){if(a){d.innerText=a.subject;
f.innerText=Browser.i18n.getMessage("participants")+": "+Object.keys(a.participants).join(", ");for(var g=0;g<a.messages.length;g++){0!=g&&(e=document.createElement("div"),e.className="evernoteEmailDivider evernoteEmailDark evernoteEmailShort",b.appendChild(e));var m=document.createElement("div");m.className="evernoteEmail evernoteEmailSelectedMessage";h=document.createElement("div");h.className="evernoteEmailCheckbox";h.addEventListener("click",function(){/evernoteEmailSelectedMessage/.test(this.parentNode.className)?
E(this.parentNode):D(this.parentNode)});m.appendChild(h);var p=document.createElement("div"),n=document.createElement("span");n.className="evernoteEmailHeader evernoteEmailMedium";n.innerText=a.messages[g].author.name;p.appendChild(n);n=document.createElement("span");n.className="evernoteEmailDimmed evernoteEmailSmall evernoteEmailRight";n.innerText=a.messages[g].date;p.appendChild(n);m.appendChild(p);p=document.createElement("div");p.className="evernoteEmailBody";p.innerHTML=a.messages[g].body;m.appendChild(p);
if(0<a.messages[g].attachments.length){p=document.createElement("div");p.className="evernoteEmailAttachments";for(n=0;n<a.messages[g].attachments.length;n++){var q=document.createElement("div"),r=document.createElement("span");r.className="evernoteEmailSmall";var s=document.createElement("span");s.className="evernoteEmailDimmed evernoteEmailSmall evernoteEmailSize";r.textContent=a.messages[g].attachments[n].name;s.textContent="("+a.messages[g].attachments[n].size+")";q.setAttribute("evernote_attachment_url",
a.messages[g].attachments[n].url);q.setAttribute("evernote_attachment_name",r.textContent);q.setAttribute("evernote_attachment_mime",a.messages[g].attachments[n].mime);q.appendChild(r);q.appendChild(s);p.appendChild(q)}m.appendChild(p)}b.appendChild(m)}c.parentNode&&c.parentNode.removeChild(c);t.appendChild(b)}else alert(k)})};this.expandPreview=function(){for(var a=e,c=e.parentNode;c;){if(u(c,e)){c.enNudgeDescendToNode=e;e=c;break}c=c.parentNode}a!==e&&k.outlineElement(e,!1,!0,!0)};this.contractPreview=
function(){var a=e;if(e.enNudgeDescendToNode){var c=e.enNudgeDescendToNode;delete e.enNudgeDescendToNode;e=c}else e=C(e);a!==e&&k.outlineElement(e,!1,!0,!0)};this.moveToElementAbove=function(){for(var a=e.previousElementSibling;a;){if(u(a,e)){e=a;k.outlineElement(e,!1,!0,!0);break}a=a.previousElementSibling}};this.moveToElementBelow=function(){for(var a=e.nextElementSibling;a;){if(u(a,e)){e=a;k.outlineElement(e,!1,!0,!0);break}a=a.nextElementSibling}};this.isPointOnVeil=function(a,c){var b=parseFloat(k.getElement().style.borderTopWidth),
d=parseFloat(k.getElement().style.borderRightWidth),e=parseFloat(k.getElement().style.borderBottomWidth),g=parseFloat(k.getElement().style.borderLeftWidth),h=parseFloat(k.getElement().style.width),m=parseFloat(k.getElement().style.height);return a<h-d&&a>g&&c>b&&c<m-e?!1:!0};this.reset=function(){v=r=m=null};this.gray=function(){s();k.reset();k.gray()};this.previewSelection=I;Object.preventExtensions(this)};
