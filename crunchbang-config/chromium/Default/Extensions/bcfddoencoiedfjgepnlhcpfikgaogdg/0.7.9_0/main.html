<html>
<head>
<meta name="title" content="QR-Code Tag" />
<link rel="stylesheet" type="text/css" href="main.css" />
<script language="javascript" src="utils.js"></script>
<script type="text/javascript" charset="utf-8" src="jquery-1.4.2.js"></script>
<script type="text/javascript" src="http://w.sharethis.com/button/sharethis.js#publisher=e4ec9411-3fc9-499d-b4a0-5b2418a1eb62&type=website"></script>
<script type="text/javascript" charset="utf-8">

function isUrl(s) {
	var regexp = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/
	return regexp.test(s);
}

function onLoadContextMenuClick()
{
	if (localStorage["shorten_url"] == "true" && isUrl(localStorage["cur_tab_url"]))
	{
		var encURL = encodeURIComponent(localStorage["cur_tab_url"]);
		debugPrint("shorten_url: " + localStorage["cur_tab_url"]);
		debugPrint("encoded: " + encURL);

		$.get('http://api.bit.ly/v3/shorten?login='+localStorage["bitly_login"]+'&apiKey='+localStorage["bitly_api_key"]+'&longUrl='+encURL+'&format=json',
			function(data, textStatus) {
				var bitly = JSON.parse(data);
				if (bitly.status_code != 200)
				{
					displayStatusMessage('Failed to shorten URL with bit.ly. Please try again and verify your login and api key. Error code: ' + bitly.status_code);
					return;
				}
				localStorage["cur_tab_url"] = bitly.data.url; // save away for filesave window if user choose this feature. 
				generateQRImage(bitly.data.url, 'qrCodePlaceHolder');
				displayShareInfo(bitly.data.url);
			}, 'text');
	}
	else
	{
		debugPrint("NOT shorten_url");
		//var qrImg = getQRImage(localStorage["cur_tab_url"]);
		//document.body.appendChild(qrImg);
		generateQRImage(localStorage["cur_tab_url"], 'qrCodePlaceHolder');
		displayShareInfo(localStorage["cur_tab_url"]);
	}
}
</script>
</head>

<body onload="onLoadContextMenuClick()">
	<div id="closeButton" onclick="window.close();">X</div><br />
	<div id="qrCodePlaceHolder"></div>
	<div id="shareContainer">
		<div id="shareContainerTitle">Share QR code on:</div>
		<span id="fbPlaceHolder"></span>
		<span id="twitterPlaceHolder"></span>
		<span id="fileSavePlaceHolder" onclick="onLinkNewClick();"><img src="icons/filesave.png" alt="" /></span>
	</div>
</body>
</html>
